<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EpicWeatherBox Admin</title>
<!-- Sun favicon - fun happy sun icon! -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%231a1a2e'/%3E%3Cg fill='%23FFD93D' stroke='%23FFD93D' stroke-width='2' stroke-linecap='round'%3E%3Cline x1='32' y1='8' x2='32' y2='15'/%3E%3Cline x1='49' y1='15' x2='44' y2='20'/%3E%3Cline x1='56' y1='32' x2='49' y2='32'/%3E%3Cline x1='49' y1='49' x2='44' y2='44'/%3E%3Cline x1='32' y1='56' x2='32' y2='49'/%3E%3Cline x1='15' y1='49' x2='20' y2='44'/%3E%3Cline x1='8' y1='32' x2='15' y2='32'/%3E%3Cline x1='15' y1='15' x2='20' y2='20'/%3E%3C/g%3E%3Cdefs%3E%3CradialGradient id='sg' cx='40%25' cy='40%25'%3E%3Cstop offset='0%25' stop-color='%23FFE66D'/%3E%3Cstop offset='100%25' stop-color='%23FFD93D'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='14' fill='url(%23sg)'/%3E%3Ccircle cx='27' cy='29' r='2' fill='%23FF9500'/%3E%3Ccircle cx='37' cy='29' r='2' fill='%23FF9500'/%3E%3Cpath d='M26 36Q32 42 38 36' stroke='%23FF9500' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E">
<!-- iOS home screen icon (must be PNG, not SVG) -->
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAIAAACyr5FlAAAD8ElEQVR42u3d33HUMBCAcZ2GV4b30ANDC5SQQlJNCkkJtEATFMDQAA8EMLHP/33W7v2+p+QmPl32Pq9kWV5dHh4+FWCIKgQgB8gBcoAcIAfIAXKAHCAHyAGQA+QAOUAOkAPkADlADpAD5ADIAXKAHCAHyAFygBwgB8gBcgDkADlADuzIOyEopXz/+uHNKx+//BAWmQPkADlADpAD5AA5QA6QA+QAOQBygBwgB+5Zjv7NdJDjnxlZ/Wj//6ohYpfPjxDe1yhnVSY/onjfqByDq/Ry+BHI+3a7lZR+DH7+ZterXhrfVzZWNJP9L61fyqbJHxEtDzAJlsCPoPkvxgxpaD/i9oyXQHvZHxHlScOOeP8oY6ZIcuwV69UpZ5eGAo2mg8mxMeIDx77/PHHMz2+7tRXtOiueHCvi/vbvJ4WYJ8qCFmNegYeUY1H0//vL1VpcUWT+SDni3ExUOfrfQT/6+2sxQ5FMs3aB5eh+E2Nm7K7FkCIjfsSt5hB7JdjvuJ9mRuf9u0J0P0/oOh+xM8dYOjlai6EU8iZ/RK8Ak02Oc8y44kexTJAZ3S4m06Kkygx+JJejCTPS+VGLZdzFQxXpxxwtpI3WPsmdy9FQh5Kuc6k6FJ1L6m6lzTQev3PxIDUyytHoaCPRyEPmQEm62Gdp2nh5fv3h8Wlxk6uPDXvP5W621Pj71XZ/nfk1bznWmAPkyJI2Jl/f61hyuE7Jes2iW0EDA9KNp86m0f7j03AvMGdQueVYciDYqUKO4RN93VzFlmNljmCK3P5YVysgB1ytlFtU5wE5EPJU0a0glxyvp12v5k6jhL1lL3OAHCAHyBFn2BG5LoPMgYxyTCePl+fD12uNNxG8nEvNvzTwOD9u0EQxQ7q9Xx9fMrj7evE5NkSZhil5a4KNrSc9YgXX/PeMXyIsQ8G4xX4sFWXFm6QoHpdIjnV+lANWDw1VriVHww8r7K7ISNbJUnMyTx3SuQ+zbLRksidKVI00VZHaxQ87zRRl/hg2V51aFYzNlJd7KTV52j2XdGbkqSY47MdtFPnT0MSGL+Q4MWcMb2pxtB/Xr1r71hpzNLST1yk7NWXaj8ceb/Z4sztksTukfWXtK2tHajtSk8Ne9uRIHeW4n7wyo5zxWGyI+Y/KDH5ElSPNnEFEP5oec9zSjH5bRzQUy/XKDPkjnhz9OOa4IR7IjxoljpmWSkTxvoaIY756YiG8r8pn8d5T9rwnB8gBcoAcIAfIAXKAHCAHQA6QA+QAOUAOFAuMIXOAHCAHyAGQA+QAOUAOkAPkADlADpAD5AA5hADkADlADpAD5AA5QA6QA+QAOQBygBwgB8gBcoAcIAfIgaz8AsiE48cDHGsLAAAAAElFTkSuQmCC">
<!-- Android/PWA settings -->
<meta name="theme-color" content="#1a1a2e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WeatherBox">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,system-ui,sans-serif;background:#1a1a2e;color:#eee;min-height:100vh}
.container{max-width:800px;margin:0 auto;padding:15px}
h1{color:#00d4ff;text-align:center;padding:15px 0;font-size:1.5em}
.grid{display:grid;grid-template-columns:1fr;gap:15px}
@media(min-width:600px){.grid{grid-template-columns:260px 1fr}}
.card{background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;border:1px solid rgba(255,255,255,0.1)}
.card h3{color:#00d4ff;margin-bottom:12px;font-size:1em}
.preview-wrap{display:flex;flex-direction:column;align-items:center}
#preview{border:2px solid #333;border-radius:8px;background:#000;image-rendering:pixelated}
.preview-info{margin-top:8px;font-size:0.8em;color:#888}
.btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;transition:all 0.2s}
.btn-primary{background:#00d4ff;color:#1a1a2e}
.btn-primary:hover{background:#00a8cc}
.btn-secondary{background:rgba(255,255,255,0.1);color:#eee}
.btn-secondary:hover{background:rgba(255,255,255,0.2)}
.btn-add{background:rgba(0,212,255,0.15);color:#00d4ff;border:1px dashed #00d4ff}
.btn-add:hover{background:rgba(0,212,255,0.25)}
.btn-add.disabled{opacity:0.4;cursor:not-allowed;pointer-events:none;border-style:solid}
.form-group{margin-bottom:12px}
.form-group label{display:block;margin-bottom:4px;font-size:0.85em;color:#aaa}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px;border:1px solid #333;border-radius:6px;background:#2a2a4e;color:#eee;font-size:0.9em}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#00d4ff}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.weather-now{text-align:center;padding:10px}
.weather-temp{font-size:2.5em;font-weight:bold}
.weather-cond{font-size:1.1em;color:#aaa}
.weather-icon{font-size:2em}
.forecast{display:flex;justify-content:space-between;margin-top:10px;overflow-x:auto}
.forecast-day{text-align:center;padding:5px;min-width:45px}
.forecast-day .day{font-size:0.7em;color:#888}
.forecast-day .icon{font-size:1.2em}
.forecast-day .temp{font-size:0.8em}
.status{padding:8px;border-radius:6px;margin-top:10px;font-size:0.85em}
.status.success{background:rgba(0,200,100,0.2);color:#0c6}
.status.error{background:rgba(200,50,50,0.2);color:#f66}
.tabs{display:flex;border-bottom:1px solid #333;margin-bottom:15px}
.tab{padding:10px 15px;cursor:pointer;border-bottom:2px solid transparent;color:#888;font-size:0.9em}
.tab.active{color:#00d4ff;border-color:#00d4ff}
.tab-content{display:none}
.tab-content.active{display:block}
.links{margin-top:15px;text-align:center}
.links a{color:#00d4ff;margin:0 10px;font-size:0.85em}

/* Carousel styles */
.carousel-list{min-height:100px}
.carousel-item{background:rgba(255,255,255,0.03);border:1px solid #333;border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:grab}
.carousel-item:active{cursor:grabbing}
.carousel-item.dragging{opacity:0.5;border-color:#00d4ff}
.carousel-item .drag-handle{color:#666;font-size:1.2em}
.carousel-item .item-icon{font-size:1.3em}
.carousel-item .item-info{flex:1}
.carousel-item .item-title{font-weight:bold;font-size:0.9em}
.carousel-item .item-desc{font-size:0.75em;color:#888;margin-top:2px}
.carousel-item .item-edit{background:none;border:none;color:#666;font-size:1em;cursor:pointer;padding:4px 8px}
.carousel-item .item-edit:hover{color:#00d4ff}
.carousel-item .item-remove{background:none;border:none;color:#666;font-size:1.2em;cursor:pointer;padding:4px 8px}
.carousel-item .item-remove:hover{color:#f66}
.carousel-counters{display:flex;gap:15px;margin-top:10px;font-size:0.8em;color:#888}
.add-buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

/* Modal styles */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#1a1a2e;border:1px solid #333;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal-content h3{color:#00d4ff;margin-bottom:15px}
.modal-buttons{display:flex;gap:10px;margin-top:15px;justify-content:flex-end}

/* Info boxes for system tab */
.info-box{background:rgba(255,255,255,0.05);border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.info-label{color:#888;font-size:0.85em}
.info-value{color:#00d4ff;font-weight:500}
.update-badge{background:#2a5a2a;color:#6f6;font-size:0.75em;padding:3px 8px;border-radius:4px;margin-left:8px;text-decoration:none}
.update-badge:hover{background:#3a7a3a}

/* Toggle switch */
.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #333}
.toggle-row:last-child{border-bottom:none}
.toggle{position:relative;width:44px;height:24px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#333;border-radius:24px;transition:0.3s}
.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:0.3s}
.toggle input:checked+.toggle-slider{background:#00d4ff}
.toggle input:checked+.toggle-slider:before{transform:translateX(20px)}

/* Color picker styles */
.color-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #333}
.color-row:last-child{border-bottom:none}
.color-label{flex:1;font-size:0.85em}
.color-preview{width:32px;height:24px;border-radius:4px;border:1px solid #555}
.color-input{width:60px;padding:4px 6px;border:1px solid #333;border-radius:4px;background:#2a2a4e;color:#eee;font-family:monospace;font-size:0.85em}
.color-group{margin-bottom:15px}
.color-group-title{font-size:0.9em;color:#00d4ff;margin-bottom:8px;font-weight:bold}
.mode-selector{display:flex;gap:8px;margin-bottom:15px}
.mode-btn{flex:1;padding:8px;border:1px solid #333;border-radius:6px;background:#2a2a4e;color:#888;cursor:pointer;font-size:0.85em;text-align:center}
.mode-btn.active{border-color:#00d4ff;color:#00d4ff;background:rgba(0,212,255,0.1)}
.theme-selector{display:flex;gap:8px;margin-bottom:15px}
.theme-btn{flex:1;padding:10px 8px;border:2px solid #333;border-radius:8px;background:#2a2a4e;color:#eee;cursor:pointer;font-size:0.85em;text-align:center}
.theme-btn.active{border-color:#00d4ff;color:#00d4ff}
.theme-btn .theme-name{font-weight:bold}
.theme-btn .theme-desc{font-size:0.75em;color:#888;margin-top:4px}
.custom-colors{padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;margin-top:15px}
.custom-colors.hidden{display:none}

/* Location search dropdown */
.search-wrap{position:relative}
.search-dropdown{position:absolute;top:100%;left:0;right:0;background:#2a2a4e;border:1px solid #333;border-top:none;border-radius:0 0 6px 6px;max-height:240px;overflow-y:auto;z-index:10;display:none}
.search-dropdown.active{display:block}
.search-dropdown-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #333}
.search-dropdown-item:last-child{border-bottom:none}
.search-dropdown-item:hover{background:rgba(0,212,255,0.1)}
.search-dropdown-item .city-name{color:#fff;font-weight:500}
.search-dropdown-item .city-detail{color:#888;font-size:0.8em;margin-top:2px}
.search-loading{padding:12px;text-align:center;color:#888;font-size:0.85em}
.search-divider{border-top:1px solid #333;margin:12px 0;padding-top:12px}
.search-divider-text{font-size:0.75em;color:#666;margin-bottom:8px}
</style>
</head>
<body>
<div class="container">
<h1 style="display:flex;align-items:center;justify-content:center;gap:12px"><svg width="36" height="36" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#1a1a2e"/><g fill="#FFD93D" stroke="#FFD93D" stroke-width="2" stroke-linecap="round"><line x1="32" y1="8" x2="32" y2="15"/><line x1="49" y1="15" x2="44" y2="20"/><line x1="56" y1="32" x2="49" y2="32"/><line x1="49" y1="49" x2="44" y2="44"/><line x1="32" y1="56" x2="32" y2="49"/><line x1="15" y1="49" x2="20" y2="44"/><line x1="8" y1="32" x2="15" y2="32"/><line x1="15" y1="15" x2="20" y2="20"/></g><defs><radialGradient id="sg" cx="40%" cy="40%"><stop offset="0%" stop-color="#FFE66D"/><stop offset="100%" stop-color="#FFD93D"/></radialGradient></defs><circle cx="32" cy="32" r="14" fill="url(#sg)"/><circle cx="27" cy="29" r="2" fill="#FF9500"/><circle cx="37" cy="29" r="2" fill="#FF9500"/><path d="M26 36Q32 42 38 36" stroke="#FF9500" stroke-width="2" fill="none" stroke-linecap="round"/></svg><span><span style="color:#00d4ff">Epic</span><span style="color:#fff">WeatherBox</span></span></h1>
<div class="grid">
<div>
<div class="card preview-wrap">
<canvas id="preview" width="240" height="240"></canvas>
<div class="preview-info">240x240 Display Preview</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="cycleScreen()">Next Screen</button>
<button class="btn btn-secondary" onclick="refreshPreview()">Refresh</button>
</div>
</div>
<div class="card" style="margin-top:15px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h3 style="margin:0">Current Weather</h3>
<button class="btn btn-secondary" style="padding:4px 10px;font-size:0.8em" onclick="cycleWeatherLocation()">Next â–¶</button>
</div>
<div id="weather-display">Loading...</div>
</div>
</div>
<div>
<div class="card">
<div class="tabs">
<div class="tab active" data-tab="carousel">Carousel</div>
<div class="tab" data-tab="display">Display</div>
<div class="tab" data-tab="theme">Theme</div>
<div class="tab" data-tab="system">System</div>
</div>

<!-- CAROUSEL TAB -->
<div id="carousel" class="tab-content active">
<p id="carousel-desc" style="font-size:0.85em;color:#888;margin-bottom:12px">Drag to reorder screens.</p>
<div id="carousel-list" class="carousel-list"></div>
<div class="add-buttons">
<button class="btn btn-add" data-type="location" onclick="openModal('location')">+ Location</button>
<button class="btn btn-add" data-type="countdown" onclick="openModal('countdown')">+ Countdown</button>
<button class="btn btn-add" data-type="custom" onclick="openModal('custom')">+ Custom Text</button>
<button class="btn btn-add" data-type="youtube" onclick="openModal('youtube')">+ YouTube</button>
<button class="btn btn-add" data-type="image" onclick="openModal('image')">+ Image</button>
</div>
<div class="carousel-counters">
<span>Locations: <span id="loc-count">0</span>/3</span>
<span>Countdowns: <span id="cd-count">0</span>/3</span>
<span>Custom: <span id="cust-count">0</span>/3</span>
<span>YouTube: <span id="yt-count">0</span>/1</span>
<span>Images: <span id="img-count">0</span>/3</span>
</div>
<div class="btn-row" style="margin-top:15px">
<button class="btn btn-primary" onclick="saveCarousel()">Save Carousel</button>
</div>
<div id="carousel-status"></div>
</div>

<!-- DISPLAY TAB -->
<div id="display" class="tab-content">
<div class="form-group">
<label>Temperature Unit</label>
<select id="temp-unit">
<option value="f">Fahrenheit</option>
<option value="c">Celsius</option>
</select>
</div>
<div class="form-group">
<label>Screen Cycle (seconds)</label>
<input type="number" id="cycle-time" value="10" min="3" max="60">
</div>
<div class="form-group">
<label>Brightness</label>
<input type="range" id="brightness" min="1" max="100" value="80">
<span id="brightness-val">80%</span>
</div>
<div class="form-group" style="margin-top:15px">
<label style="margin-bottom:8px">Screen Options</label>
<div class="toggle-row">
<span>Show Forecast Screens</span>
<label class="toggle"><input type="checkbox" id="show-forecast" checked><span class="toggle-slider"></span></label>
</div>
<p style="font-size:0.75em;color:#666;margin-top:8px">When enabled, each location shows 3 screens (current + 2 forecast). When disabled, only current weather is shown.</p>
</div>
<div class="form-group" style="margin-top:15px">
<label style="margin-bottom:8px">Night Mode</label>
<div class="toggle-row">
<span>Enable Night Mode</span>
<label class="toggle"><input type="checkbox" id="night-mode-enabled"><span class="toggle-slider"></span></label>
</div>
<div id="night-mode-settings" style="margin-top:10px">
<div class="form-row">
<div class="form-group">
<label>Start (dim)</label>
<select id="night-start"></select>
</div>
<div class="form-group">
<label>End (brighten)</label>
<select id="night-end"></select>
</div>
</div>
<div class="form-group">
<label>Night Brightness</label>
<input type="range" id="night-brightness" min="1" max="100" value="20">
<span id="night-brightness-val">20%</span>
</div>
</div>
<p style="font-size:0.75em;color:#666;margin-top:8px">Dims display during night hours. Sunrise/Sunset options use weather data.</p>
</div>
<div class="btn-row">
<button class="btn btn-primary" onclick="saveDisplay()">Save Settings</button>
</div>
<div id="display-status"></div>
</div>

<!-- THEME TAB -->
<div id="theme" class="tab-content">
<div class="form-group">
<label>Select Theme</label>
<div class="theme-selector">
<div class="theme-btn active" data-theme="0"><div class="theme-name">Classic</div><div class="theme-desc">Original colors</div></div>
<div class="theme-btn" data-theme="1"><div class="theme-name">Minecraft</div><div class="theme-desc">Blocky earth tones</div></div>
<div class="theme-btn" data-theme="2"><div class="theme-name">Custom</div><div class="theme-desc">Your colors</div></div>
</div>
</div>
<div class="form-group">
<label>Theme Mode</label>
<div class="mode-selector">
<div class="mode-btn active" data-mode="0">Auto</div>
<div class="mode-btn" data-mode="1">Dark</div>
<div class="mode-btn" data-mode="2">Light</div>
</div>
<p style="font-size:0.75em;color:#666;margin-top:4px">Auto uses dark at night, light during day.</p>
</div>
<div id="custom-colors" class="custom-colors hidden">
<div class="form-group">
<label>Start From</label>
<div class="btn-row">
<button class="btn btn-secondary" onclick="loadThemeColors(0)">Load Classic</button>
<button class="btn btn-secondary" onclick="loadThemeColors(1)">Load Minecraft</button>
<button class="btn btn-secondary" style="background:#633" onclick="clearCustomTheme()">Clear All</button>
</div>
</div>
<div class="color-group">
<div class="color-group-title">Dark Mode - Background Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements on the main screen background</p>
<div class="color-row"><span class="color-label">Background</span><input type="color" class="color-preview" id="dark-bg"><input type="text" class="color-input" id="dark-bg-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Primary Text</span><input type="color" class="color-preview" id="dark-text"><input type="text" class="color-input" id="dark-text-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Time &amp; Headers</span><input type="color" class="color-preview" id="dark-cyan"><input type="text" class="color-input" id="dark-cyan-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">High Temp</span><input type="color" class="color-preview" id="dark-orange"><input type="text" class="color-input" id="dark-orange-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Low Temp</span><input type="color" class="color-preview" id="dark-blue"><input type="text" class="color-input" id="dark-blue-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Secondary Text</span><input type="color" class="color-preview" id="dark-gray"><input type="text" class="color-input" id="dark-gray-hex" maxlength="7"></div>
</div>
<div class="color-group">
<div class="color-group-title">Dark Mode - Card Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements inside forecast cards and footer bars</p>
<div class="color-row"><span class="color-label">Card Background</span><input type="color" class="color-preview" id="dark-card"><input type="text" class="color-input" id="dark-card-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Text</span><input type="color" class="color-preview" id="dark-textOnCard"><input type="text" class="color-input" id="dark-textOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Accents</span><input type="color" class="color-preview" id="dark-cyanOnCard"><input type="text" class="color-input" id="dark-cyanOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card High Temp</span><input type="color" class="color-preview" id="dark-orangeOnCard"><input type="text" class="color-input" id="dark-orangeOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Low Temp</span><input type="color" class="color-preview" id="dark-blueOnCard"><input type="text" class="color-input" id="dark-blueOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Secondary</span><input type="color" class="color-preview" id="dark-grayOnCard"><input type="text" class="color-input" id="dark-grayOnCard-hex" maxlength="7"></div>
</div>
<div class="color-group">
<div class="color-group-title">Light Mode - Background Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements on the main screen background</p>
<div class="color-row"><span class="color-label">Background</span><input type="color" class="color-preview" id="light-bg"><input type="text" class="color-input" id="light-bg-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Primary Text</span><input type="color" class="color-preview" id="light-text"><input type="text" class="color-input" id="light-text-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Time &amp; Headers</span><input type="color" class="color-preview" id="light-cyan"><input type="text" class="color-input" id="light-cyan-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">High Temp</span><input type="color" class="color-preview" id="light-orange"><input type="text" class="color-input" id="light-orange-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Low Temp</span><input type="color" class="color-preview" id="light-blue"><input type="text" class="color-input" id="light-blue-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Secondary Text</span><input type="color" class="color-preview" id="light-gray"><input type="text" class="color-input" id="light-gray-hex" maxlength="7"></div>
</div>
<div class="color-group">
<div class="color-group-title">Light Mode - Card Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements inside forecast cards and footer bars</p>
<div class="color-row"><span class="color-label">Card Background</span><input type="color" class="color-preview" id="light-card"><input type="text" class="color-input" id="light-card-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Text</span><input type="color" class="color-preview" id="light-textOnCard"><input type="text" class="color-input" id="light-textOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Accents</span><input type="color" class="color-preview" id="light-cyanOnCard"><input type="text" class="color-input" id="light-cyanOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card High Temp</span><input type="color" class="color-preview" id="light-orangeOnCard"><input type="text" class="color-input" id="light-orangeOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Low Temp</span><input type="color" class="color-preview" id="light-blueOnCard"><input type="text" class="color-input" id="light-blueOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Secondary</span><input type="color" class="color-preview" id="light-grayOnCard"><input type="text" class="color-input" id="light-grayOnCard-hex" maxlength="7"></div>
</div>
</div>
<div class="btn-row" style="margin-top:15px">
<button class="btn btn-primary" onclick="saveTheme()">Save Theme</button>
</div>
<div id="theme-status"></div>
</div>

<!-- SYSTEM TAB -->
<div id="system" class="tab-content">
<div class="form-group">
<label>Device Info</label>
<div id="device-info">Loading...</div>
</div>
<div class="form-group" style="margin-top:15px">
<label>System Actions</label>
<div class="btn-row" style="flex-wrap:wrap">
<button class="btn btn-secondary" onclick="refreshWeather()">Refresh Weather</button>
<button class="btn btn-secondary" onclick="location.href='/update'">Firmware Update</button>
<button class="btn btn-secondary" style="background:#c33" onclick="if(confirm('Reboot device?'))location.href='/reboot'">Reboot</button>
</div>
<div class="btn-row" style="margin-top:8px;flex-wrap:wrap">
<button class="btn btn-secondary" style="background:#963" onclick="if(confirm('Safe Mode boots with minimal features for recovery. Continue?'))location.href='/api/safemode'">Safe Mode</button>
<button class="btn btn-secondary" style="background:#369" onclick="if(confirm('Reload Admin refreshes the UI from firmware and reboots. Continue?'))location.href='/api/reprovision'">Reload Admin</button>
<button class="btn btn-secondary" style="background:#933" onclick="if(confirm('Factory Reset clears all settings and WiFi credentials. This cannot be undone. Continue?'))location.href='/reset'">Factory Reset</button>
</div>
</div>
<div class="form-group" style="margin-top:20px">
<label>API Endpoints</label>
<div class="info-box"><span class="info-label">/api/weather</span><a href="/api/weather" class="info-value" style="text-decoration:none">Weather data</a></div>
<div class="info-box"><span class="info-label">/api/config</span><a href="/api/config" class="info-value" style="text-decoration:none">Location config</a></div>
<div class="info-box"><span class="info-label">/api/status</span><a href="/api/status" class="info-value" style="text-decoration:none">Device status</a></div>
</div>
<div class="form-group" style="margin-top:15px">
<label>Project Links</label>
<div class="info-box"><span class="info-label">GitHub</span><a href="https://github.com/ryanmaule/epicweatherbox" target="_blank" class="info-value" style="text-decoration:none">Source &amp; Docs</a></div>
<div class="info-box"><span class="info-label">Releases</span><a href="https://github.com/ryanmaule/epicweatherbox/releases" target="_blank" class="info-value" style="text-decoration:none">Download firmware</a></div>
<div class="info-box"><span class="info-label">Issues</span><a href="https://github.com/ryanmaule/epicweatherbox/issues" target="_blank" class="info-value" style="text-decoration:none">Report bugs</a></div>
</div>
</div>
</div>
<div style="text-align:center;padding:15px 0;color:#666;font-size:0.8em">
&copy; 2025 <a href="https://github.com/ryanmaule" target="_blank">ryanmaule</a> | <a href="https://github.com/ryanmaule/epicweatherbox" target="_blank">EpicWeatherBox</a>
</div>
</div>
</div>
</div>

<!-- MODALS -->
<div id="modal-location" class="modal">
<div class="modal-content">
<h3 id="modal-location-title">Add Location</h3>
<div class="form-group">
<label>Search for City</label>
<div class="search-wrap">
<input type="text" id="loc-search" placeholder="Type city name (e.g., Aurora, Ontario)" autocomplete="off">
<div id="loc-search-results" class="search-dropdown"></div>
</div>
</div>
<div class="search-divider">
<p class="search-divider-text">Or enter coordinates manually:</p>
</div>
<div class="form-group">
<label>Location Name</label>
<input type="text" id="new-loc-name" placeholder="e.g., Seattle">
</div>
<div class="form-row">
<div class="form-group">
<label>Latitude</label>
<input type="number" id="new-loc-lat" step="0.0001" placeholder="47.6062">
</div>
<div class="form-group">
<label>Longitude</label>
<input type="number" id="new-loc-lon" step="0.0001" placeholder="-122.3321">
</div>
</div>
<button class="btn btn-secondary" onclick="useMyLocationForNew()" style="width:100%">Use My Location</button>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('location')">Cancel</button>
<button class="btn btn-primary" id="btn-location-save" onclick="saveLocation()">Add</button>
</div>
</div>
</div>

<div id="modal-countdown" class="modal">
<div class="modal-content">
<h3 id="modal-countdown-title">Add Countdown</h3>
<div class="form-group">
<label>Event Type</label>
<select id="new-cd-type" onchange="updateCountdownFields()">
<option value="0">Birthday</option>
<option value="1">Easter</option>
<option value="2">Halloween</option>
<option value="3">Valentine's Day</option>
<option value="4">Christmas</option>
<option value="5">Custom Date</option>
</select>
</div>
<div class="form-group" id="cd-title-group">
<label>Title</label>
<input type="text" id="new-cd-title" maxlength="31" placeholder="e.g., Mom's Birthday">
</div>
<div class="form-row" id="cd-date-group">
<div class="form-group">
<label>Month</label>
<select id="new-cd-month">
<option value="1">January</option><option value="2">February</option><option value="3">March</option>
<option value="4">April</option><option value="5">May</option><option value="6">June</option>
<option value="7">July</option><option value="8">August</option><option value="9">September</option>
<option value="10">October</option><option value="11">November</option><option value="12">December</option>
</select>
</div>
<div class="form-group">
<label>Day</label>
<input type="number" id="new-cd-day" min="1" max="31" value="1">
</div>
</div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('countdown')">Cancel</button>
<button class="btn btn-primary" id="btn-countdown-save" onclick="saveCountdown()">Add</button>
</div>
</div>
</div>

<div id="modal-custom" class="modal">
<div class="modal-content">
<h3 id="modal-custom-title">Add Custom Text Screen</h3>
<div class="form-group">
<label>Header (max 16 chars)</label>
<input type="text" id="new-cust-header" maxlength="16" placeholder="e.g., Quote">
</div>
<div class="form-group">
<label>Body Text (max 80 chars)</label>
<textarea id="new-cust-body" maxlength="80" rows="3" placeholder="Your message..."></textarea>
<div style="font-size:0.75em;color:#666;margin-top:4px"><span id="new-body-count">0</span>/80</div>
</div>
<div class="form-group">
<label>Footer (max 30 chars)</label>
<input type="text" id="new-cust-footer" maxlength="30" placeholder="e.g., Have a great day!">
</div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('custom')">Cancel</button>
<button class="btn btn-primary" id="btn-custom-save" onclick="saveCustomScreen()">Add</button>
</div>
</div>
</div>

<div id="modal-youtube" class="modal">
<div class="modal-content">
<h3 id="modal-youtube-title">YouTube Channel Stats</h3>
<div class="form-group">
<label>YouTube API Key</label>
<input type="password" id="yt-api-key" placeholder="AIzaSy...">
<p style="font-size:0.75em;color:#666;margin-top:4px">Get a free key from <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:#00d4ff">Google Cloud Console</a>. Enable YouTube Data API v3.</p>
</div>
<div class="form-group">
<label>Channel Handle</label>
<input type="text" id="yt-channel" placeholder="sterlings.funtube">
<p style="font-size:0.75em;color:#666;margin-top:4px">Without the @ symbol. Example: sterlings.funtube</p>
</div>
<div id="youtube-status"></div>
<div id="youtube-stats" style="margin-top:10px"></div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('youtube')">Cancel</button>
<button class="btn btn-secondary" onclick="testYouTube()">Test</button>
<button class="btn btn-primary" id="btn-youtube-save" onclick="saveYouTube()">Add to Carousel</button>
</div>
</div>
</div>

<div id="modal-image" class="modal">
<div class="modal-content">
<h3 id="modal-image-title">Upload Image</h3>
<div class="form-group">
<label>Header Text (shown top-left, max 16 chars)</label>
<input type="text" id="image-header" maxlength="16" placeholder="e.g. Family">
</div>
<div class="form-group">
<label>Select JPG Image (max 100KB)</label>
<input type="file" id="image-file" accept=".jpg,.jpeg" onchange="validateImagePreview()">
<p style="font-size:0.75em;color:#666;margin-top:4px">Recommended size: 240x240 pixels. Images will be centered on display.</p>
</div>
<div id="image-preview-wrap" style="display:none;margin-top:10px;text-align:center">
<img id="image-preview" style="max-width:200px;max-height:200px;border-radius:6px;border:1px solid #333">
<div id="image-size" style="font-size:0.8em;color:#888;margin-top:5px"></div>
</div>
<div id="image-status"></div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('image')">Cancel</button>
<button class="btn btn-primary" id="btn-image-save" onclick="uploadImage()" disabled>Upload</button>
</div>
</div>
</div>

<script>
// Data storage
let carouselItems = [];
let locations = [];
let countdowns = [];
let customScreens = [];
let youtubeData = null;  // YouTube configuration and stats
let imageScreens = [];   // Image screen data
let currentScreen = 0;
let currentWeatherLocationIdx = 0;
let weatherData = null;
let themeData = null;

// Edit mode tracking
let editingItem = null; // {carouselIdx, type, dataIndex} when editing, null when adding
let searchTimeout = null; // Debounce timer for location search

const canvas = document.getElementById('preview');
const ctx = canvas.getContext('2d');

const ICONS = {
  location: 'ðŸ“',
  countdown: {
    0: 'ðŸŽ‚', // Birthday
    1: 'ðŸ°', // Easter
    2: 'ðŸŽƒ', // Halloween
    3: 'â¤ï¸', // Valentine
    4: 'ðŸŽ„', // Christmas
    5: 'ðŸ“…'  // Custom
  },
  custom: 'ðŸ“',
  youtube: 'â–¶ï¸',
  image: 'ðŸ–¼ï¸'
};

const EVENT_NAMES = ['Birthday', 'Easter', 'Halloween', 'Valentine\'s', 'Christmas', 'Custom'];
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  };
});

// Brightness slider
document.getElementById('brightness').oninput = e => {
  document.getElementById('brightness-val').textContent = e.target.value + '%';
};

// Night brightness slider
document.getElementById('night-brightness').oninput = e => {
  document.getElementById('night-brightness-val').textContent = e.target.value + '%';
};

// Night mode toggle - show/hide settings
document.getElementById('night-mode-enabled').onchange = function() {
  document.getElementById('night-mode-settings').style.display = this.checked ? 'block' : 'none';
};

// Initialize night mode time dropdowns
function initNightModeSelects() {
  const startSel = document.getElementById('night-start');
  const endSel = document.getElementById('night-end');
  // Add sunrise/sunset options
  let opts = '<option value="-1">Sunset</option><option value="-2">Sunrise</option>';
  // Add hour options
  for (let h = 0; h < 24; h++) {
    const ampm = h < 12 ? 'AM' : 'PM';
    const hour12 = h === 0 ? 12 : (h > 12 ? h - 12 : h);
    opts += '<option value="' + h + '">' + hour12 + ':00 ' + ampm + '</option>';
  }
  startSel.innerHTML = opts;
  endSel.innerHTML = opts;
  // Set defaults
  startSel.value = '22';  // 10 PM
  endSel.value = '7';     // 7 AM
}
initNightModeSelects();

// Body character counter for new custom screen
document.getElementById('new-cust-body').oninput = e => {
  document.getElementById('new-body-count').textContent = e.target.value.length;
};

// Modal handling
function openModal(type) {
  editingItem = null; // Reset to add mode
  updateModalMode(type, false);
  document.getElementById('modal-' + type).classList.add('active');
  if (type === 'countdown') updateCountdownFields();
}

function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('active');
  editingItem = null; // Reset edit mode
  // Clear fields
  if (type === 'location') {
    document.getElementById('loc-search').value = '';
    document.getElementById('loc-search-results').classList.remove('active');
    document.getElementById('loc-search-results').innerHTML = '';
    document.getElementById('new-loc-name').value = '';
    document.getElementById('new-loc-lat').value = '';
    document.getElementById('new-loc-lon').value = '';
  } else if (type === 'countdown') {
    document.getElementById('new-cd-type').value = '0';
    document.getElementById('new-cd-title').value = '';
    document.getElementById('new-cd-month').value = '1';
    document.getElementById('new-cd-day').value = '1';
  } else if (type === 'custom') {
    document.getElementById('new-cust-header').value = '';
    document.getElementById('new-cust-body').value = '';
    document.getElementById('new-cust-footer').value = '';
    document.getElementById('new-body-count').textContent = '0';
  } else if (type === 'image') {
    document.getElementById('image-file').value = '';
    document.getElementById('image-header').value = '';
    document.getElementById('image-preview-wrap').style.display = 'none';
    document.getElementById('image-status').innerHTML = '';
    document.getElementById('btn-image-save').disabled = true;
  }
}

function updateCountdownFields() {
  const type = parseInt(document.getElementById('new-cd-type').value);
  const titleGroup = document.getElementById('cd-title-group');
  const dateGroup = document.getElementById('cd-date-group');

  // Show/hide title based on type
  if (type === 0 || type === 5) { // Birthday or Custom
    titleGroup.style.display = 'block';
  } else {
    titleGroup.style.display = 'none';
  }

  // Show/hide date based on type (Easter is calculated)
  if (type === 1) { // Easter
    dateGroup.style.display = 'none';
  } else if (type === 2) { // Halloween - Oct 31
    dateGroup.style.display = 'none';
  } else if (type === 3) { // Valentine - Feb 14
    dateGroup.style.display = 'none';
  } else if (type === 4) { // Christmas - Dec 25
    dateGroup.style.display = 'none';
  } else {
    dateGroup.style.display = 'grid';
  }
}

// Render carousel list
function renderCarousel() {
  const list = document.getElementById('carousel-list');
  list.innerHTML = '';

  let locCount = 0, cdCount = 0, custCount = 0, ytCount = 0, imgCount = 0;

  carouselItems.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'carousel-item';
    div.draggable = true;
    div.dataset.index = idx;

    let icon, title, desc;
    if (item.type === 0) { // Location
      const loc = locations[item.dataIndex] || {};
      icon = ICONS.location;
      title = loc.name || 'Location ' + (item.dataIndex + 1);
      desc = `Lat: ${loc.lat?.toFixed(4) || '?'}, Lon: ${loc.lon?.toFixed(4) || '?'}`;
      locCount++;
    } else if (item.type === 1) { // Countdown
      const cd = countdowns[item.dataIndex] || {};
      icon = ICONS.countdown[cd.type] || 'ðŸ“…';
      title = cd.title || EVENT_NAMES[cd.type] || 'Countdown';
      if (cd.type === 1) {
        desc = 'Easter (calculated)';
      } else {
        desc = MONTH_NAMES[(cd.month || 1) - 1] + ' ' + (cd.day || 1);
      }
      cdCount++;
    } else if (item.type === 2) { // Custom
      const cust = customScreens[item.dataIndex] || {};
      icon = ICONS.custom;
      title = cust.header || 'Custom Screen';
      desc = (cust.body || '').substring(0, 40) + (cust.body?.length > 40 ? '...' : '');
      custCount++;
    } else if (item.type === 3) { // YouTube
      icon = ICONS.youtube;
      title = youtubeData?.channelName || youtubeData?.channelHandle || 'YouTube';
      desc = youtubeData?.valid ? `${formatNumber(youtubeData.subscribers)} subscribers` : 'Channel stats';
      ytCount++;
    } else if (item.type === 4) { // Image
      const img = imageScreens[item.dataIndex] || {};
      icon = ICONS.image;
      title = img.header || (img.filename ? img.filename.split('/').pop() : 'Image ' + (item.dataIndex + 1));
      desc = img.size ? formatBytes(img.size) : (img.valid ? 'Uploaded' : 'Not found');
      imgCount++;
    }

    div.innerHTML = `
      <span class="drag-handle">â˜°</span>
      <span class="item-icon">${icon}</span>
      <div class="item-info">
        <div class="item-title">${escapeHtml(title)}</div>
        <div class="item-desc">${escapeHtml(desc)}</div>
      </div>
      <button class="item-edit" onclick="editCarouselItem(${idx})">âœŽ</button>
      <button class="item-remove" onclick="removeCarouselItem(${idx})">Ã—</button>
    `;

    // Drag events
    div.ondragstart = e => {
      e.dataTransfer.setData('text/plain', idx);
      div.classList.add('dragging');
    };
    div.ondragend = () => div.classList.remove('dragging');
    div.ondragover = e => e.preventDefault();
    div.ondrop = e => {
      e.preventDefault();
      const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
      const toIdx = idx;
      if (fromIdx !== toIdx) {
        const item = carouselItems.splice(fromIdx, 1)[0];
        carouselItems.splice(toIdx, 0, item);
        renderCarousel();
      }
    };

    list.appendChild(div);
  });

  document.getElementById('loc-count').textContent = locCount;
  document.getElementById('cd-count').textContent = cdCount;
  document.getElementById('cust-count').textContent = custCount;
  document.getElementById('yt-count').textContent = ytCount;
  document.getElementById('img-count').textContent = imgCount;

  // Update add button states based on limits
  updateAddButtonStates(locCount, cdCount, custCount, ytCount, imgCount);
}

function updateAddButtonStates(locCount, cdCount, custCount, ytCount, imgCount) {
  const limits = { location: 3, countdown: 3, custom: 3, youtube: 1, image: 3 };
  const counts = { location: locCount, countdown: cdCount, custom: custCount, youtube: ytCount, image: imgCount };

  document.querySelectorAll('.add-buttons .btn-add').forEach(btn => {
    const type = btn.dataset.type;
    if (type && limits[type] !== undefined) {
      const isDisabled = counts[type] >= limits[type];
      btn.classList.toggle('disabled', isDisabled);
      btn.disabled = isDisabled;
    }
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// Add/Edit items
function saveLocation() {
  const name = document.getElementById('new-loc-name').value.trim();
  const lat = parseFloat(document.getElementById('new-loc-lat').value);
  const lon = parseFloat(document.getElementById('new-loc-lon').value);

  if (!name || isNaN(lat) || isNaN(lon)) {
    alert('Please fill in all fields');
    return;
  }

  if (editingItem && editingItem.type === 0) {
    // Update existing location
    locations[editingItem.dataIndex] = { name, lat, lon, enabled: true };
  } else {
    // Add new location
    if (locations.length >= 3) {
      alert('Maximum 3 locations allowed');
      return;
    }
    const idx = locations.length;
    locations.push({ name, lat, lon, enabled: true });
    carouselItems.push({ type: 0, dataIndex: idx });
  }

  closeModal('location');
  renderCarousel();
}

// Location search functions
function initLocationSearch() {
  const searchInput = document.getElementById('loc-search');
  const resultsDiv = document.getElementById('loc-search-results');
  if (!searchInput || !resultsDiv) return;

  searchInput.oninput = function() {
    const query = this.value.trim();
    if (searchTimeout) clearTimeout(searchTimeout);

    if (query.length < 2) {
      resultsDiv.classList.remove('active');
      resultsDiv.innerHTML = '';
      return;
    }

    resultsDiv.innerHTML = '<div class="search-loading">Searching...</div>';
    resultsDiv.classList.add('active');
    searchTimeout = setTimeout(() => searchLocation(query), 300);
  };

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
      resultsDiv.classList.remove('active');
    }
  });
}

async function searchLocation(query) {
  const resultsDiv = document.getElementById('loc-search-results');
  try {
    const r = await fetch('/api/geocode?q=' + encodeURIComponent(query));
    const data = await r.json();

    if (data.error) {
      resultsDiv.innerHTML = '<div class="search-loading">' + escapeHtml(data.error) + '</div>';
      return;
    }

    if (!data.results || data.results.length === 0) {
      resultsDiv.innerHTML = '<div class="search-loading">No results found</div>';
      return;
    }

    let html = '';
    data.results.slice(0, 20).forEach(loc => {
      const name = escapeHtml(loc.name);
      const display = escapeHtml(loc.display);
      const lat = loc.lat.toFixed(4);
      const lon = loc.lon.toFixed(4);
      html += '<div class="search-dropdown-item" onclick="selectSearchResult(\'' + escapeAttr(loc.name) + '\', ' + lat + ', ' + lon + ')">' +
        '<div class="city-name">' + name + '</div>' +
        '<div class="city-detail">' + display + '</div>' +
        '</div>';
    });
    resultsDiv.innerHTML = html;
  } catch (e) {
    resultsDiv.innerHTML = '<div class="search-loading">Search failed</div>';
  }
}

function selectSearchResult(name, lat, lon) {
  document.getElementById('new-loc-name').value = name;
  document.getElementById('new-loc-lat').value = lat;
  document.getElementById('new-loc-lon').value = lon;
  document.getElementById('loc-search').value = '';
  document.getElementById('loc-search-results').classList.remove('active');
}

function escapeAttr(text) {
  return (text || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

function saveCountdown() {
  const type = parseInt(document.getElementById('new-cd-type').value);
  let title = document.getElementById('new-cd-title').value.trim();
  let month = parseInt(document.getElementById('new-cd-month').value);
  let day = parseInt(document.getElementById('new-cd-day').value);

  // Set defaults for preset types
  if (type === 1) { month = 4; day = 1; title = title || 'Easter'; }
  else if (type === 2) { month = 10; day = 31; title = title || 'Halloween'; }
  else if (type === 3) { month = 2; day = 14; title = title || "Valentine's Day"; }
  else if (type === 4) { month = 12; day = 25; title = title || 'Christmas'; }
  else if (!title) {
    alert('Please enter a title');
    return;
  }

  if (editingItem && editingItem.type === 1) {
    // Update existing countdown
    countdowns[editingItem.dataIndex] = { type, month, day, title };
  } else {
    // Add new countdown
    if (countdowns.length >= 3) {
      alert('Maximum 3 countdowns allowed');
      return;
    }
    const idx = countdowns.length;
    countdowns.push({ type, month, day, title });
    carouselItems.push({ type: 1, dataIndex: idx });
  }

  closeModal('countdown');
  renderCarousel();
}

function saveCustomScreen() {
  const header = document.getElementById('new-cust-header').value.trim();
  const body = document.getElementById('new-cust-body').value.trim();
  const footer = document.getElementById('new-cust-footer').value.trim();

  if (!body) {
    alert('Please enter body text');
    return;
  }

  if (editingItem && editingItem.type === 2) {
    // Update existing custom screen
    customScreens[editingItem.dataIndex] = { header, body, footer };
  } else {
    // Add new custom screen
    if (customScreens.length >= 3) {
      alert('Maximum 3 custom screens allowed');
      return;
    }
    const idx = customScreens.length;
    customScreens.push({ header, body, footer });
    carouselItems.push({ type: 2, dataIndex: idx });
  }

  closeModal('custom');
  renderCarousel();
}

// Modal mode management for Add vs Edit
function updateModalMode(type, isEdit) {
  const titles = {
    location: ['Add Location', 'Edit Location'],
    countdown: ['Add Countdown', 'Edit Countdown'],
    custom: ['Add Custom Text Screen', 'Edit Custom Screen'],
    youtube: ['YouTube Channel Stats', 'Edit YouTube'],
    image: ['Upload Image', 'Replace Image']
  };
  const buttons = {
    location: ['Add', 'Update'],
    countdown: ['Add', 'Update'],
    custom: ['Add', 'Update'],
    youtube: ['Add to Carousel', 'Update'],
    image: ['Upload', 'Replace']
  };

  const titleEl = document.getElementById('modal-' + type + '-title');
  const btnEl = document.getElementById('btn-' + type + '-save');

  if (titleEl && titles[type]) {
    titleEl.textContent = titles[type][isEdit ? 1 : 0];
  }
  if (btnEl && buttons[type]) {
    btnEl.textContent = buttons[type][isEdit ? 1 : 0];
  }
}

function editCarouselItem(carouselIdx) {
  const item = carouselItems[carouselIdx];
  if (!item) return;

  editingItem = { carouselIdx, type: item.type, dataIndex: item.dataIndex };

  if (item.type === 0) { // Location
    const loc = locations[item.dataIndex];
    if (!loc) return;
    document.getElementById('loc-search').value = '';
    document.getElementById('loc-search-results').classList.remove('active');
    document.getElementById('new-loc-name').value = loc.name || '';
    document.getElementById('new-loc-lat').value = loc.lat || '';
    document.getElementById('new-loc-lon').value = loc.lon || '';
    updateModalMode('location', true);
    document.getElementById('modal-location').classList.add('active');

  } else if (item.type === 1) { // Countdown
    const cd = countdowns[item.dataIndex];
    if (!cd) return;
    document.getElementById('new-cd-type').value = cd.type || 0;
    document.getElementById('new-cd-title').value = cd.title || '';
    document.getElementById('new-cd-month').value = cd.month || 1;
    document.getElementById('new-cd-day').value = cd.day || 1;
    updateCountdownFields();
    updateModalMode('countdown', true);
    document.getElementById('modal-countdown').classList.add('active');

  } else if (item.type === 2) { // Custom
    const cust = customScreens[item.dataIndex];
    if (!cust) return;
    document.getElementById('new-cust-header').value = cust.header || '';
    document.getElementById('new-cust-body').value = cust.body || '';
    document.getElementById('new-cust-footer').value = cust.footer || '';
    document.getElementById('new-body-count').textContent = (cust.body || '').length;
    updateModalMode('custom', true);
    document.getElementById('modal-custom').classList.add('active');

  } else if (item.type === 3) { // YouTube
    updateModalMode('youtube', true);
    document.getElementById('modal-youtube').classList.add('active');

  } else if (item.type === 4) { // Image
    const img = imageScreens[item.dataIndex];
    document.getElementById('image-file').value = '';
    document.getElementById('image-header').value = img && img.header ? img.header : '';
    document.getElementById('image-preview-wrap').style.display = 'none';
    document.getElementById('image-status').innerHTML = '';
    document.getElementById('btn-image-save').disabled = false; // Enable for header-only edits
    // Show current image info
    if (img) {
      const shortName = img.filename.split('/').pop();
      showStatus('image-status', 'info', 'Current: ' + shortName + ' (' + formatBytes(img.size) + '). Change header or select new file to replace.');
    }
    updateModalMode('image', true);
    document.getElementById('modal-image').classList.add('active');
  }
}

function removeCarouselItem(idx) {
  if (!confirm('Remove this item?')) return;

  const item = carouselItems[idx];
  carouselItems.splice(idx, 1);

  // Don't remove from data arrays - just from carousel
  // The dataIndex still points to the correct data

  renderCarousel();
}

function useMyLocationForNew() {
  if (!navigator.geolocation) {
    alert('Geolocation not supported');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    document.getElementById('new-loc-lat').value = pos.coords.latitude.toFixed(4);
    document.getElementById('new-loc-lon').value = pos.coords.longitude.toFixed(4);
  }, () => alert('Could not get location'));
}

// Save carousel
async function saveCarousel() {
  // Rebuild data arrays to only include items that are in the carousel
  // and fix dataIndex values to match their actual array positions
  const usedLocs = [];
  const usedCds = [];
  const usedCusts = [];
  const newCarousel = [];

  carouselItems.forEach(item => {
    if (item.type === 0) { // Location
      const loc = locations[item.dataIndex];
      if (loc) {
        const newIdx = usedLocs.length;
        usedLocs.push(loc);
        newCarousel.push({ type: 0, dataIndex: newIdx });
      }
    } else if (item.type === 1) { // Countdown
      const cd = countdowns[item.dataIndex];
      if (cd) {
        const newIdx = usedCds.length;
        usedCds.push(cd);
        newCarousel.push({ type: 1, dataIndex: newIdx });
      }
    } else if (item.type === 2) { // Custom
      const cust = customScreens[item.dataIndex];
      if (cust) {
        const newIdx = usedCusts.length;
        usedCusts.push(cust);
        newCarousel.push({ type: 2, dataIndex: newIdx });
      }
    } else if (item.type === 3) { // YouTube
      // YouTube has no dataIndex array - just add type 3 with dataIndex 0
      newCarousel.push({ type: 3, dataIndex: 0 });
    } else if (item.type === 4) { // Image
      // Image screens are stored separately, just preserve the carousel entry
      const img = imageScreens[item.dataIndex];
      if (img) {
        newCarousel.push({ type: 4, dataIndex: item.dataIndex });
      }
    }
  });

  const data = {
    carousel: newCarousel,
    locations: usedLocs,
    countdowns: usedCds,
    customScreens: usedCusts
  };

  try {
    const r = await fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await r.json();
    showStatus('carousel-status', result.success ? 'success' : 'error', result.message);
    if (result.success) setTimeout(() => location.reload(), 2000);
  } catch (e) {
    showStatus('carousel-status', 'error', 'Failed to save');
  }
}

// Load initial data
async function loadData() {
  try {
    const [weather, status, config, themes] = await Promise.all([
      fetch('/api/weather').then(r => r.json()),
      fetch('/api/status').then(r => r.json()),
      fetch('/api/config').then(r => r.json()).catch(() => ({})),
      fetch('/api/themes').then(r => r.json()).catch(() => ({}))
    ]);
    updateWeatherDisplay(weather);
    updateDeviceInfo(status);
    updateConfig(config);
    updateThemes(themes);
    drawPreview(weather);
  } catch (e) { console.error(e); }
}

function updateWeatherDisplay(data) {
  weatherData = data;  // Store for cycling

  // Use locations array if available, otherwise fall back to primary
  let w = null;
  if (data.locations && data.locations.length > 0) {
    if (currentWeatherLocationIdx >= data.locations.length) {
      currentWeatherLocationIdx = 0;
    }
    w = data.locations[currentWeatherLocationIdx];
  } else if (data.primary && data.primary.valid) {
    w = data.primary;
  }

  if (!w || !w.valid) {
    document.getElementById('weather-display').innerHTML = '<div class="status error">Weather unavailable</div>';
    return;
  }

  let html = `<div class="weather-now">
    <div class="weather-icon">${w.current.icon}</div>
    <div class="weather-temp">${Math.round(w.current.temperature)}Â°</div>
    <div class="weather-cond">${w.current.condition} - ${w.location}</div>
  </div><div class="forecast">`;
  w.forecast.slice(0, 5).forEach(d => {
    html += `<div class="forecast-day"><div class="day">${d.day}</div><div class="icon">${d.icon}</div><div class="temp">${Math.round(d.tempMax)}Â°</div></div>`;
  });
  html += '</div>';
  document.getElementById('weather-display').innerHTML = html;
}

function cycleWeatherLocation() {
  if (!weatherData || !weatherData.locations || weatherData.locations.length <= 1) {
    return; // Nothing to cycle
  }
  currentWeatherLocationIdx = (currentWeatherLocationIdx + 1) % weatherData.locations.length;
  updateWeatherDisplay(weatherData);
}

function updateDeviceInfo(s) {
  document.getElementById('device-info').innerHTML = `
    <div class="info-box"><span class="info-label">Version</span><span class="info-value" id="version-info">${s.version}</span></div>
    <div class="info-box"><span class="info-label">IP Address</span><span class="info-value">${s.ip}</span></div>
    <div class="info-box"><span class="info-label">Uptime</span><span class="info-value">${Math.floor(s.uptime / 60)}m ${s.uptime % 60}s</span></div>
    <div class="info-box"><span class="info-label">Free RAM</span><span class="info-value">${(s.heap / 1024).toFixed(1)} KB</span></div>
    <div class="info-box"><span class="info-label">WiFi Signal</span><span class="info-value">${s.rssi} dBm</span></div>`;
  checkForUpdate(s.version);
}

function compareVersions(v1, v2) {
  const p1 = v1.replace(/^v/, '').split('.').map(Number);
  const p2 = v2.replace(/^v/, '').split('.').map(Number);
  for (let i = 0; i < 3; i++) {
    const a = p1[i] || 0, b = p2[i] || 0;
    if (a < b) return -1;
    if (a > b) return 1;
  }
  return 0;
}

async function checkForUpdate(currentVersion) {
  try {
    const r = await fetch('https://api.github.com/repos/ryanmaule/epicweatherbox/releases/latest');
    if (!r.ok) return;
    const data = await r.json();
    const latestVersion = data.tag_name;
    if (compareVersions(currentVersion, latestVersion) < 0) {
      const versionEl = document.getElementById('version-info');
      if (versionEl) {
        versionEl.innerHTML = currentVersion +
          ` <a href="${data.html_url}" target="_blank" class="update-badge">${latestVersion} available</a>`;
      }
    }
  } catch (e) { /* Ignore errors - update check is optional */ }
}

function updateConfig(c) {
  // Load carousel items
  if (c.carousel && Array.isArray(c.carousel)) {
    carouselItems = c.carousel;
  } else {
    carouselItems = [];
  }

  // Load locations
  if (c.locations && Array.isArray(c.locations)) {
    locations = c.locations;
  } else {
    // Legacy format
    locations = [];
    if (c.primary) {
      locations.push({ name: c.primary.name, lat: c.primary.lat, lon: c.primary.lon, enabled: true });
    }
    if (c.secondary && c.secondary.enabled) {
      locations.push({ name: c.secondary.name, lat: c.secondary.lat, lon: c.secondary.lon, enabled: true });
    }
    // Create default carousel from locations
    if (carouselItems.length === 0) {
      locations.forEach((_, i) => carouselItems.push({ type: 0, dataIndex: i }));
    }
  }

  // Load countdowns
  if (c.countdowns && Array.isArray(c.countdowns)) {
    countdowns = c.countdowns;
  } else {
    countdowns = [];
  }

  // Load custom screens
  if (c.customScreens && Array.isArray(c.customScreens)) {
    customScreens = c.customScreens;
  } else if (c.customScreenEnabled && c.customScreenBody) {
    // Legacy single custom screen
    customScreens = [{
      header: c.customScreenHeader || '',
      body: c.customScreenBody || '',
      footer: c.customScreenFooter || ''
    }];
  } else {
    customScreens = [];
  }

  // Display settings
  if (c.display) {
    document.getElementById('temp-unit').value = c.display.unit || 'f';
    document.getElementById('cycle-time').value = c.display.cycle || 10;
    document.getElementById('brightness').value = c.display.brightness || 80;
    document.getElementById('brightness-val').textContent = (c.display.brightness || 80) + '%';
  }

  // Load showForecast setting
  const showForecastEl = document.getElementById('show-forecast');
  if (showForecastEl) {
    showForecastEl.checked = c.showForecast !== false;  // Default to true
    updateCarouselDescription();
  }

  // Load night mode settings
  document.getElementById('night-mode-enabled').checked = c.nightModeEnabled !== false;
  document.getElementById('night-start').value = c.nightModeStartHour !== undefined ? c.nightModeStartHour : 22;
  document.getElementById('night-end').value = c.nightModeEndHour !== undefined ? c.nightModeEndHour : 7;
  document.getElementById('night-brightness').value = c.nightModeBrightness || 20;
  document.getElementById('night-brightness-val').textContent = (c.nightModeBrightness || 20) + '%';
  document.getElementById('night-mode-settings').style.display = (c.nightModeEnabled !== false) ? 'block' : 'none';

  renderCarousel();
}

function drawPreview(data) {
  weatherData = data;  // Store for use
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, 240, 240);

  // Get weather data - prefer locations array
  let w = null;
  if (data && data.locations && data.locations.length > 0 && data.locations[0].valid) {
    w = data.locations[0];
  } else if (data && data.primary && data.primary.valid) {
    w = data.primary;
  }

  if (!w) {
    ctx.fillStyle = '#666';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('No weather data', 120, 120);
    return;
  }

  // Draw based on current screen state
  drawScreenByIndex(currentScreen, w);
}

function drawCurrentWeather(w) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);
  ctx.textAlign = 'center';
  ctx.fillStyle = '#00d4ff';
  ctx.font = 'bold 14px sans-serif';
  ctx.fillText(w.location, 120, 25);
  ctx.font = '60px sans-serif';
  ctx.fillText(w.current.icon, 120, 100);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 48px sans-serif';
  ctx.fillText(Math.round(w.current.temperature) + 'Â°', 120, 160);
  ctx.fillStyle = '#aaa';
  ctx.font = '16px sans-serif';
  ctx.fillText(w.current.condition, 120, 185);
  ctx.font = '12px sans-serif';
  ctx.fillText('Wind: ' + w.current.windSpeed + ' mph', 120, 210);
  const now = new Date();
  ctx.fillStyle = '#666';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 120, 232);
}

function cycleScreen() {
  const showForecast = document.getElementById('show-forecast')?.checked !== false;

  // Count total screens based on carousel items
  let totalScreens = 0;
  carouselItems.forEach(item => {
    if (item.type === 0) totalScreens += showForecast ? 3 : 1; // Location = 3 or 1 screens
    else totalScreens += 1; // Countdown or Custom = 1 screen
  });
  if (totalScreens === 0) totalScreens = 1;

  currentScreen = (currentScreen + 1) % totalScreens;
  if (weatherData) {
    // Get weather data for preview
    let w = null;
    if (weatherData.locations && weatherData.locations.length > 0 && weatherData.locations[0].valid) {
      w = weatherData.locations[0];
    } else if (weatherData.primary && weatherData.primary.valid) {
      w = weatherData.primary;
    }
    if (w) drawScreenByIndex(currentScreen, w);
  }
}

function drawScreenByIndex(screenIdx, weather) {
  const showForecast = document.getElementById('show-forecast')?.checked !== false;

  // Map screen index to carousel item
  let idx = 0;
  for (let i = 0; i < carouselItems.length; i++) {
    const item = carouselItems[i];
    if (item.type === 0) {
      // Location: 3 screens (current, forecast 1-3, forecast 4-6) or just 1
      const screensForLoc = showForecast ? 3 : 1;
      if (screenIdx < idx + screensForLoc) {
        const subScreen = screenIdx - idx;
        const locIdx = item.dataIndex;
        // Get weather for this location
        let w = weather;
        if (weatherData && weatherData.locations && weatherData.locations[locIdx]) {
          w = weatherData.locations[locIdx];
        }
        if (subScreen === 0) drawCurrentWeather(w);
        else drawForecastPreview(w, subScreen - 1);
        return;
      }
      idx += screensForLoc;
    } else if (item.type === 1) {
      // Countdown: 1 screen
      if (screenIdx === idx) {
        const cd = countdowns[item.dataIndex];
        if (cd) drawCountdownPreview(cd);
        return;
      }
      idx += 1;
    } else if (item.type === 2) {
      // Custom: 1 screen
      if (screenIdx === idx) {
        const cust = customScreens[item.dataIndex];
        if (cust) drawCustomPreview(cust);
        return;
      }
      idx += 1;
    } else if (item.type === 3) {
      // YouTube: 1 screen
      if (screenIdx === idx) {
        drawYouTubePreview();
        return;
      }
      idx += 1;
    } else if (item.type === 4) {
      // Image: 1 screen
      if (screenIdx === idx) {
        const img = imageScreens[item.dataIndex];
        drawImagePreview(img);
        return;
      }
      idx += 1;
    }
  }
  // Fallback to current weather
  drawCurrentWeather(weather);
}

function drawForecastPreview(w, forecastSet) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);
  ctx.textAlign = 'center';

  // Header
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);
  ctx.textAlign = 'right';
  ctx.fillStyle = '#888';
  ctx.fillText('Forecast', 230, 20);

  // Location
  ctx.textAlign = 'center';
  ctx.fillStyle = '#00d4ff';
  ctx.font = 'bold 16px sans-serif';
  ctx.fillText(w.location, 120, 45);

  // Forecast days
  const startDay = forecastSet * 3;
  const days = w.forecast.slice(startDay, startDay + 3);

  days.forEach((d, i) => {
    const y = 70 + i * 55;
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.fillRect(20, y, 200, 48);

    ctx.fillStyle = '#888';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(d.day, 30, y + 18);

    ctx.font = '24px sans-serif';
    ctx.fillText(d.icon, 30, y + 42);

    ctx.fillStyle = '#fff';
    ctx.font = 'bold 24px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(d.tempMax) + 'Â°', 210, y + 35);
  });

  // Dots
  drawDots(forecastSet + 1, 3);
}

function drawCountdownPreview(cd) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);
  ctx.textAlign = 'center';

  // Header
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);
  ctx.textAlign = 'right';
  ctx.fillStyle = '#888';
  ctx.fillText('Countdown', 230, 20);

  // Icon
  const icon = ICONS.countdown[cd.type] || 'ðŸ“…';
  ctx.font = '48px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(icon, 120, 85);

  // Title
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 20px sans-serif';
  ctx.fillText(cd.title || EVENT_NAMES[cd.type] || 'Event', 120, 125);

  // Calculate days
  const targetDate = getEventDate(cd);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const diffTime = targetDate.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  ctx.font = 'bold 36px sans-serif';
  ctx.fillStyle = '#00d4ff';
  ctx.fillText(diffDays + ' days', 120, 175);

  // Date
  ctx.font = '14px sans-serif';
  ctx.fillStyle = '#888';
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  ctx.fillText(dayNames[targetDate.getDay()] + ', ' + MONTH_NAMES[targetDate.getMonth()] + ' ' + targetDate.getDate(), 120, 200);
}

function drawCustomPreview(cust) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);

  // Header
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);
  ctx.textAlign = 'right';
  ctx.fillStyle = '#888';
  if (cust.header) {
    ctx.fillText('â˜… ' + cust.header, 230, 20);
  }

  // Body text
  ctx.textAlign = 'center';
  ctx.fillStyle = '#fff';
  const bodyLen = (cust.body || '').length;
  if (bodyLen <= 40) {
    ctx.font = 'bold 18px sans-serif';
  } else if (bodyLen <= 80) {
    ctx.font = 'bold 14px sans-serif';
  } else {
    ctx.font = '12px sans-serif';
  }

  // Simple word wrap
  const words = (cust.body || '').split(' ');
  let lines = [];
  let currentLine = '';
  words.forEach(word => {
    const testLine = currentLine ? currentLine + ' ' + word : word;
    if (ctx.measureText(testLine).width > 200) {
      if (currentLine) lines.push(currentLine);
      currentLine = word;
    } else {
      currentLine = testLine;
    }
  });
  if (currentLine) lines.push(currentLine);

  const lineHeight = bodyLen <= 40 ? 28 : (bodyLen <= 80 ? 22 : 18);
  const startY = 120 - (lines.length - 1) * lineHeight / 2;
  lines.forEach((line, i) => {
    ctx.fillText(line, 120, startY + i * lineHeight);
  });

  // Footer
  if (cust.footer) {
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    const footerWidth = ctx.measureText(cust.footer).width + 20;
    ctx.fillRect(120 - footerWidth / 2, 205, footerWidth, 25);
    ctx.fillStyle = '#00d4ff';
    ctx.font = '12px sans-serif';
    ctx.fillText(cust.footer, 120, 222);
  }
}

function drawYouTubePreview() {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);

  // Header - time on left
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);

  // YouTube logo-style play button (centered, larger)
  const logoX = 120, logoY = 55;
  // Red rounded rectangle background
  ctx.fillStyle = '#FF0000';
  ctx.beginPath();
  ctx.roundRect(logoX - 28, logoY - 18, 56, 36, 8);
  ctx.fill();
  // White play triangle
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.moveTo(logoX - 10, logoY - 12);
  ctx.lineTo(logoX + 14, logoY);
  ctx.lineTo(logoX - 10, logoY + 12);
  ctx.closePath();
  ctx.fill();

  // Channel name below logo
  ctx.textAlign = 'center';
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 14px sans-serif';
  const channelName = youtubeData?.channelName || youtubeData?.channelHandle || 'YouTube Channel';
  ctx.fillText(channelName, 120, 100);

  // Subscriber count (large, prominent)
  ctx.fillStyle = '#00d4ff';
  ctx.font = 'bold 42px sans-serif';
  const subs = youtubeData?.valid ? formatNumber(youtubeData.subscribers) : '0';
  ctx.fillText(subs, 120, 150);
  ctx.font = '13px sans-serif';
  ctx.fillStyle = '#888';
  ctx.fillText('subscribers', 120, 168);

  // Views and Videos side by side
  ctx.fillStyle = 'rgba(255,255,255,0.05)';
  ctx.beginPath();
  ctx.roundRect(20, 180, 95, 45, 6);
  ctx.fill();
  ctx.beginPath();
  ctx.roundRect(125, 180, 95, 45, 6);
  ctx.fill();

  // Views
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 16px sans-serif';
  const views = youtubeData?.valid ? formatNumber(youtubeData.views) : '0';
  ctx.fillText(views, 67, 200);
  ctx.font = '10px sans-serif';
  ctx.fillStyle = '#888';
  ctx.fillText('views', 67, 215);

  // Videos
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 16px sans-serif';
  const videos = youtubeData?.valid ? formatNumber(youtubeData.videos) : '0';
  ctx.fillText(videos, 172, 200);
  ctx.font = '10px sans-serif';
  ctx.fillStyle = '#888';
  ctx.fillText('videos', 172, 215);
}

function drawImagePreview(img) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);

  // Header - matches custom screen style
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);
  ctx.textAlign = 'right';
  ctx.fillStyle = '#888';
  ctx.fillText('Image', 210, 20);

  // Star icon
  ctx.fillStyle = '#00d4ff';
  ctx.font = '14px sans-serif';
  ctx.fillText('â˜…', 230, 20);

  ctx.textAlign = 'center';

  if (img && img.filename) {
    // Show image placeholder with filename
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.beginPath();
    ctx.roundRect(30, 45, 180, 160, 8);
    ctx.fill();

    // Image icon
    ctx.font = '48px sans-serif';
    ctx.fillText('ðŸ–¼ï¸', 120, 120);

    // Filename
    ctx.fillStyle = '#fff';
    ctx.font = '14px sans-serif';
    const shortName = img.filename.split('/').pop();
    ctx.fillText(shortName, 120, 165);

    // Size if available
    if (img.size) {
      ctx.fillStyle = '#888';
      ctx.font = '11px sans-serif';
      ctx.fillText(formatBytes(img.size), 120, 185);
    }
  } else {
    // No image
    ctx.fillStyle = '#888';
    ctx.font = '48px sans-serif';
    ctx.fillText('ðŸ–¼ï¸', 120, 120);
    ctx.font = '14px sans-serif';
    ctx.fillText('No Image', 120, 160);
  }
}

function getEventDate(cd) {
  const now = new Date();
  let year = now.getFullYear();
  let month = cd.month - 1;
  let day = cd.day;

  // Easter calculation
  if (cd.type === 1) {
    const easter = calculateEaster(year);
    month = easter.month;
    day = easter.day;
  }

  let date = new Date(year, month, day);
  // If date has passed, use next year
  if (date < now) {
    year++;
    if (cd.type === 1) {
      const easter = calculateEaster(year);
      month = easter.month;
      day = easter.day;
    }
    date = new Date(year, month, day);
  }
  return date;
}

function calculateEaster(year) {
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  return { month, day };
}

function drawDots(current, total) {
  const dotSpacing = 12;
  const startX = 120 - (total - 1) * dotSpacing / 2;
  for (let i = 0; i < total; i++) {
    ctx.beginPath();
    ctx.arc(startX + i * dotSpacing, 232, 3, 0, Math.PI * 2);
    ctx.fillStyle = i === current ? '#fff' : '#444';
    ctx.fill();
  }
}

function refreshPreview() {
  fetch('/api/weather').then(r => r.json()).then(drawPreview);
}

async function saveDisplay() {
  const showForecast = document.getElementById('show-forecast').checked;
  const data = {
    display: {
      unit: document.getElementById('temp-unit').value,
      cycle: parseInt(document.getElementById('cycle-time').value),
      brightness: parseInt(document.getElementById('brightness').value)
    },
    showForecast: showForecast,
    nightModeEnabled: document.getElementById('night-mode-enabled').checked,
    nightModeStartHour: parseInt(document.getElementById('night-start').value),
    nightModeEndHour: parseInt(document.getElementById('night-end').value),
    nightModeBrightness: parseInt(document.getElementById('night-brightness').value)
  };
  try {
    const r = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    const result = await r.json();
    showStatus('display-status', result.success ? 'success' : 'error', result.message);
    updateCarouselDescription();
  } catch (e) { showStatus('display-status', 'error', 'Failed to save'); }
}

function updateCarouselDescription() {
  // No longer needed - description is now static
}

async function refreshWeather() {
  try {
    const r = await fetch('/api/weather/refresh');
    const result = await r.json();
    if (result.success) loadData();
  } catch (e) {}
}

function showStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.textContent = msg;
  setTimeout(() => el.textContent = '', 5000);
}

// RGB565 conversion functions
// Note: Display uses RGB565 format (R in high bits 11-15, B in low bits 0-4)
function rgb565ToHex(val) {
  const r = ((val >> 11) & 0x1F) << 3;
  const g = ((val >> 5) & 0x3F) << 2;
  const b = (val & 0x1F) << 3;
  return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
}

function hexToRgb565(hex) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return ((r >> 3) << 11) | ((g >> 2) << 5) | (b >> 3);
}

// Theme UI handlers
const COLOR_FIELDS = ['bg', 'card', 'text', 'textOnCard', 'cyan', 'cyanOnCard', 'orange', 'orangeOnCard', 'blue', 'blueOnCard', 'gray', 'grayOnCard'];

function updateThemes(data) {
  themeData = data;
  if (!data || typeof data.activeTheme === 'undefined') return;

  // Update theme selector
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.theme) === data.activeTheme);
  });

  // Update mode selector
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.mode) === data.themeMode);
  });

  // Show/hide custom colors section
  const customSection = document.getElementById('custom-colors');
  customSection.classList.toggle('hidden', data.activeTheme !== 2);

  // Load custom theme colors into pickers
  if (data.themes && data.themes[2]) {
    loadColorGroup('dark', data.themes[2].dark);
    loadColorGroup('light', data.themes[2].light);
  }
}

function loadColorGroup(mode, colors) {
  if (!colors) return;
  COLOR_FIELDS.forEach(field => {
    const picker = document.getElementById(`${mode}-${field}`);
    const hex = document.getElementById(`${mode}-${field}-hex`);
    if (picker && hex && colors[field] !== undefined) {
      const hexVal = rgb565ToHex(colors[field]);
      picker.value = hexVal;
      hex.value = hexVal;
    }
  });
}

// Load colors from a built-in theme (0=Classic, 1=Minecraft)
function loadThemeColors(themeIndex) {
  if (!themeData || !themeData.themes || !themeData.themes[themeIndex]) {
    showStatus('theme-status', 'error', 'Theme data not available');
    return;
  }
  const theme = themeData.themes[themeIndex];
  loadColorGroup('dark', theme.dark);
  loadColorGroup('light', theme.light);
  showStatus('theme-status', 'success', `Loaded ${theme.name} colors`);
}

// Clear all custom theme colors to black
function clearCustomTheme() {
  if (!confirm('Clear all custom colors to black?')) return;
  const black = '#000000';
  COLOR_FIELDS.forEach(field => {
    ['dark', 'light'].forEach(mode => {
      const picker = document.getElementById(`${mode}-${field}`);
      const hex = document.getElementById(`${mode}-${field}-hex`);
      if (picker && hex) {
        picker.value = black;
        hex.value = black;
      }
    });
  });
  showStatus('theme-status', 'success', 'Colors cleared');
}

// Theme selector click handlers
document.querySelectorAll('.theme-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const customSection = document.getElementById('custom-colors');
    customSection.classList.toggle('hidden', btn.dataset.theme !== '2');
  };
});

// Mode selector click handlers
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  };
});

// Color picker sync (color input <-> hex input)
COLOR_FIELDS.forEach(field => {
  ['dark', 'light'].forEach(mode => {
    const picker = document.getElementById(`${mode}-${field}`);
    const hex = document.getElementById(`${mode}-${field}-hex`);
    if (picker && hex) {
      picker.oninput = () => { hex.value = picker.value; };
      hex.oninput = () => {
        if (/^#[0-9A-Fa-f]{6}$/.test(hex.value)) {
          picker.value = hex.value;
        }
      };
    }
  });
});

async function saveTheme() {
  const activeTheme = parseInt(document.querySelector('.theme-btn.active')?.dataset.theme || '0');
  const themeMode = parseInt(document.querySelector('.mode-btn.active')?.dataset.mode || '0');

  const data = {
    activeTheme,
    themeMode
  };

  // Include custom colors if custom theme is selected
  if (activeTheme === 2) {
    data.custom = {
      dark: {},
      light: {}
    };
    COLOR_FIELDS.forEach(field => {
      const darkHex = document.getElementById(`dark-${field}-hex`)?.value;
      const lightHex = document.getElementById(`light-${field}-hex`)?.value;
      if (darkHex && /^#[0-9A-Fa-f]{6}$/.test(darkHex)) {
        data.custom.dark[field] = hexToRgb565(darkHex);
      }
      if (lightHex && /^#[0-9A-Fa-f]{6}$/.test(lightHex)) {
        data.custom.light[field] = hexToRgb565(lightHex);
      }
    });
  }

  try {
    const r = await fetch('/api/themes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await r.json();
    showStatus('theme-status', result.success ? 'success' : 'error', result.message);
  } catch (e) {
    showStatus('theme-status', 'error', 'Failed to save theme');
  }
}

async function resetCustomTheme() {
  if (!confirm('Reset custom theme to Classic defaults?')) return;
  try {
    const r = await fetch('/api/themes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ resetCustom: true })
    });
    const result = await r.json();
    if (result.success) {
      // Reload theme data
      const themes = await fetch('/api/themes').then(r => r.json());
      updateThemes(themes);
      showStatus('theme-status', 'success', 'Custom theme reset');
    } else {
      showStatus('theme-status', 'error', result.message);
    }
  } catch (e) {
    showStatus('theme-status', 'error', 'Failed to reset theme');
  }
}

// YouTube functions
async function loadYouTube() {
  try {
    const r = await fetch('/api/youtube');
    const data = await r.json();
    youtubeData = data;  // Store for carousel display
    updateYouTubeUI(data);
    renderCarousel();  // Re-render to update YouTube button visibility
  } catch (e) {
    console.error('Failed to load YouTube data:', e);
  }
}

async function saveYouTube() {
  const apiKey = document.getElementById('yt-api-key').value.trim();
  const channel = document.getElementById('yt-channel').value.trim().replace(/^@/, '');

  if (!apiKey || !channel) {
    showStatus('youtube-status', 'error', 'Please enter API key and channel handle');
    return;
  }

  // Save config first
  try {
    const r = await fetch('/api/youtube', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ apiKey, channelHandle: channel, enabled: true })
    });
    const result = await r.json();
    if (!result.success) {
      showStatus('youtube-status', 'error', result.message || 'Failed to save');
      return;
    }
  } catch (e) {
    showStatus('youtube-status', 'error', 'Failed to save config');
    return;
  }

  // Add to carousel only if not editing (YouTube already in carousel)
  if (!editingItem || editingItem.type !== 3) {
    const hasYoutube = carouselItems.some(item => item.type === 3);
    if (!hasYoutube) {
      carouselItems.push({ type: 3, dataIndex: 0 });
    }
  }

  closeModal('youtube');
  renderCarousel();
  await loadYouTube();  // Refresh data
}

function updateYouTubeUI(data) {
  if (!data) return;

  // Update form fields in modal
  const apiKeyField = document.getElementById('yt-api-key');
  const channelField = document.getElementById('yt-channel');
  if (apiKeyField) apiKeyField.value = data.apiKey || '';
  if (channelField) channelField.value = data.channelHandle || '';

  // Update stats display in modal
  const statsDiv = document.getElementById('youtube-stats');
  if (!statsDiv) return;

  if (data.valid) {
    statsDiv.innerHTML = `
      <div class="info-box"><span class="info-label">Channel</span><span class="info-value">${escapeHtml(data.channelName || data.channelHandle)}</span></div>
      <div class="info-box"><span class="info-label">Subscribers</span><span class="info-value">${formatNumber(data.subscribers)}</span></div>
      <div class="info-box"><span class="info-label">Views</span><span class="info-value">${formatNumber(data.views)}</span></div>
      <div class="info-box"><span class="info-label">Videos</span><span class="info-value">${formatNumber(data.videos)}</span></div>
    `;
  } else if (data.lastError) {
    statsDiv.innerHTML = `
      <div class="info-box"><span class="info-label">Status</span><span class="info-value" style="color:#f66">${escapeHtml(data.lastError)}</span></div>
    `;
  } else if (!data.apiKey || !data.channelHandle) {
    statsDiv.innerHTML = '';
  } else {
    statsDiv.innerHTML = `
      <div class="info-box"><span class="info-label">Status</span><span class="info-value" style="color:#888">Click Test to verify</span></div>
    `;
  }
}

function formatNumber(num) {
  if (!num && num !== 0) return '0';
  num = parseInt(num);
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
}

function formatTimeAgo(timestamp) {
  if (!timestamp) return 'Never';
  const now = Date.now();
  const diff = now - timestamp;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hours = Math.floor(mins / 60);
  if (hours < 24) return hours + 'h ago';
  return Math.floor(hours / 24) + 'd ago';
}

async function testYouTube() {
  const apiKey = document.getElementById('yt-api-key').value.trim();
  const channel = document.getElementById('yt-channel').value.trim().replace(/^@/, '');

  if (!apiKey || !channel) {
    showStatus('youtube-status', 'error', 'Please enter API key and channel');
    return;
  }

  showStatus('youtube-status', 'success', 'Testing connection...');

  try {
    // Save config first
    await fetch('/api/youtube', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ apiKey, channelHandle: channel, enabled: true })
    });

    // Then refresh to test
    const r = await fetch('/api/youtube/refresh');
    const result = await r.json();
    showStatus('youtube-status', result.success ? 'success' : 'error', result.message);
    if (result.success) {
      setTimeout(loadYouTube, 500);
    }
  } catch (e) {
    showStatus('youtube-status', 'error', 'Connection test failed');
  }
}

// Image functions
async function loadImages() {
  try {
    const r = await fetch('/api/images');
    const data = await r.json();
    imageScreens = data.images || [];
    renderCarousel();  // Re-render to update image info
  } catch (e) {
    console.error('Failed to load images:', e);
  }
}

function validateImagePreview() {
  const fileInput = document.getElementById('image-file');
  const previewWrap = document.getElementById('image-preview-wrap');
  const previewImg = document.getElementById('image-preview');
  const sizeDiv = document.getElementById('image-size');
  const uploadBtn = document.getElementById('btn-image-save');

  if (!fileInput.files || !fileInput.files[0]) {
    previewWrap.style.display = 'none';
    uploadBtn.disabled = true;
    return;
  }

  const file = fileInput.files[0];

  // Check file type
  if (!file.type.match(/image\/jpe?g/)) {
    showStatus('image-status', 'error', 'Only JPG files are supported');
    previewWrap.style.display = 'none';
    uploadBtn.disabled = true;
    return;
  }

  // Check file size (100KB max)
  if (file.size > 102400) {
    showStatus('image-status', 'error', 'File too large (max 100KB). Current: ' + formatBytes(file.size));
    previewWrap.style.display = 'none';
    uploadBtn.disabled = true;
    return;
  }

  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    previewImg.src = e.target.result;
    previewWrap.style.display = 'block';
    sizeDiv.textContent = formatBytes(file.size);
  };
  reader.readAsDataURL(file);

  showStatus('image-status', 'success', 'Ready to upload');
  uploadBtn.disabled = false;
}

async function uploadImage() {
  const fileInput = document.getElementById('image-file');
  const header = document.getElementById('image-header').value.trim();
  const hasFile = fileInput.files && fileInput.files[0];
  const isEditing = editingItem && editingItem.type === 4;

  // For new images, require a file
  if (!isEditing && !hasFile) {
    showStatus('image-status', 'error', 'No file selected');
    return;
  }

  showStatus('image-status', 'success', isEditing && !hasFile ? 'Saving...' : 'Uploading...');
  document.getElementById('btn-image-save').disabled = true;

  try {
    // If editing without a new file, just update the header
    if (isEditing && !hasFile) {
      const r = await fetch('/api/images/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: editingItem.dataIndex, header: header })
      });
      const result = await r.json();
      if (result.success) {
        closeModal('image');
        await loadImages();
        renderCarousel();
        showStatus('carousel-status', 'success', 'Image header updated!');
      } else {
        showStatus('image-status', 'error', result.message || 'Update failed');
        document.getElementById('btn-image-save').disabled = false;
      }
      return;
    }

    // Upload new file
    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('header', header);

    // If editing, specify which index to replace
    if (isEditing) {
      formData.append('replaceIndex', editingItem.dataIndex);
    }

    const r = await fetch('/api/upload/image', {
      method: 'POST',
      body: formData
    });
    const result = await r.json();

    if (result.success) {
      // Only add to carousel if this is a new image (not editing)
      if (!isEditing) {
        carouselItems.push({ type: 4, dataIndex: result.index });
      }
      closeModal('image');
      await loadImages();  // Refresh image list
      renderCarousel();
      const msg = isEditing ? 'Image replaced!' : 'Image uploaded! Remember to save carousel.';
      showStatus('carousel-status', 'success', msg);
    } else {
      showStatus('image-status', 'error', result.message || 'Upload failed');
      document.getElementById('btn-image-save').disabled = false;
    }
  } catch (e) {
    showStatus('image-status', 'error', 'Upload failed: ' + e.message);
    document.getElementById('btn-image-save').disabled = false;
  }
}

async function deleteImage(index) {
  if (!confirm('Delete this image?')) return;

  try {
    const formData = new FormData();
    formData.append('index', index);

    const r = await fetch('/api/images/delete', {
      method: 'POST',
      body: formData
    });
    const result = await r.json();

    if (result.success) {
      // Remove from carousel
      carouselItems = carouselItems.filter(item => !(item.type === 4 && item.dataIndex === index));
      // Adjust dataIndex for remaining image items
      carouselItems.forEach(item => {
        if (item.type === 4 && item.dataIndex > index) {
          item.dataIndex--;
        }
      });
      await loadImages();
      renderCarousel();
    } else {
      alert(result.message || 'Delete failed');
    }
  } catch (e) {
    alert('Delete failed: ' + e.message);
  }
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

loadData();
loadYouTube();
loadImages();
initLocationSearch();
setInterval(loadData, 60000);
</script>
</body>
</html>
