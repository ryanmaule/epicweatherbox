<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EpicWeatherBox Admin</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,system-ui,sans-serif;background:#1a1a2e;color:#eee;min-height:100vh}
.container{max-width:800px;margin:0 auto;padding:15px}
h1{color:#00d4ff;text-align:center;padding:15px 0;font-size:1.5em}
.grid{display:grid;grid-template-columns:1fr;gap:15px}
@media(min-width:600px){.grid{grid-template-columns:260px 1fr}}
.card{background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;border:1px solid rgba(255,255,255,0.1)}
.card h3{color:#00d4ff;margin-bottom:12px;font-size:1em}
.preview-wrap{display:flex;flex-direction:column;align-items:center}
#preview{border:2px solid #333;border-radius:8px;background:#000;image-rendering:pixelated}
.preview-info{margin-top:8px;font-size:0.8em;color:#888}
.btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;transition:all 0.2s}
.btn-primary{background:#00d4ff;color:#1a1a2e}
.btn-primary:hover{background:#00a8cc}
.btn-secondary{background:rgba(255,255,255,0.1);color:#eee}
.btn-secondary:hover{background:rgba(255,255,255,0.2)}
.btn-add{background:rgba(0,212,255,0.15);color:#00d4ff;border:1px dashed #00d4ff}
.btn-add:hover{background:rgba(0,212,255,0.25)}
.form-group{margin-bottom:12px}
.form-group label{display:block;margin-bottom:4px;font-size:0.85em;color:#aaa}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px;border:1px solid #333;border-radius:6px;background:#2a2a4e;color:#eee;font-size:0.9em}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#00d4ff}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.weather-now{text-align:center;padding:10px}
.weather-temp{font-size:2.5em;font-weight:bold}
.weather-cond{font-size:1.1em;color:#aaa}
.weather-icon{font-size:2em}
.forecast{display:flex;justify-content:space-between;margin-top:10px;overflow-x:auto}
.forecast-day{text-align:center;padding:5px;min-width:45px}
.forecast-day .day{font-size:0.7em;color:#888}
.forecast-day .icon{font-size:1.2em}
.forecast-day .temp{font-size:0.8em}
.status{padding:8px;border-radius:6px;margin-top:10px;font-size:0.85em}
.status.success{background:rgba(0,200,100,0.2);color:#0c6}
.status.error{background:rgba(200,50,50,0.2);color:#f66}
.tabs{display:flex;border-bottom:1px solid #333;margin-bottom:15px}
.tab{padding:10px 15px;cursor:pointer;border-bottom:2px solid transparent;color:#888;font-size:0.9em}
.tab.active{color:#00d4ff;border-color:#00d4ff}
.tab-content{display:none}
.tab-content.active{display:block}
.links{margin-top:15px;text-align:center}
.links a{color:#00d4ff;margin:0 10px;font-size:0.85em}

/* Carousel styles */
.carousel-list{min-height:100px}
.carousel-item{background:rgba(255,255,255,0.03);border:1px solid #333;border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:grab}
.carousel-item:active{cursor:grabbing}
.carousel-item.dragging{opacity:0.5;border-color:#00d4ff}
.carousel-item .drag-handle{color:#666;font-size:1.2em}
.carousel-item .item-icon{font-size:1.3em}
.carousel-item .item-info{flex:1}
.carousel-item .item-title{font-weight:bold;font-size:0.9em}
.carousel-item .item-desc{font-size:0.75em;color:#888;margin-top:2px}
.carousel-item .item-remove{background:none;border:none;color:#666;font-size:1.2em;cursor:pointer;padding:4px 8px}
.carousel-item .item-remove:hover{color:#f66}
.carousel-counters{display:flex;gap:15px;margin-top:10px;font-size:0.8em;color:#888}
.add-buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

/* Modal styles */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#1a1a2e;border:1px solid #333;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal-content h3{color:#00d4ff;margin-bottom:15px}
.modal-buttons{display:flex;gap:10px;margin-top:15px;justify-content:flex-end}

/* Info boxes for system tab */
.info-box{background:rgba(255,255,255,0.05);border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.info-label{color:#888;font-size:0.85em}
.info-value{color:#00d4ff;font-weight:500}
.update-badge{background:#2a5a2a;color:#6f6;font-size:0.75em;padding:3px 8px;border-radius:4px;margin-left:8px;text-decoration:none}
.update-badge:hover{background:#3a7a3a}

/* Toggle switch */
.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #333}
.toggle-row:last-child{border-bottom:none}
.toggle{position:relative;width:44px;height:24px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#333;border-radius:24px;transition:0.3s}
.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:0.3s}
.toggle input:checked+.toggle-slider{background:#00d4ff}
.toggle input:checked+.toggle-slider:before{transform:translateX(20px)}

/* Color picker styles */
.color-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #333}
.color-row:last-child{border-bottom:none}
.color-label{flex:1;font-size:0.85em}
.color-preview{width:32px;height:24px;border-radius:4px;border:1px solid #555}
.color-input{width:60px;padding:4px 6px;border:1px solid #333;border-radius:4px;background:#2a2a4e;color:#eee;font-family:monospace;font-size:0.85em}
.color-group{margin-bottom:15px}
.color-group-title{font-size:0.9em;color:#00d4ff;margin-bottom:8px;font-weight:bold}
.mode-selector{display:flex;gap:8px;margin-bottom:15px}
.mode-btn{flex:1;padding:8px;border:1px solid #333;border-radius:6px;background:#2a2a4e;color:#888;cursor:pointer;font-size:0.85em;text-align:center}
.mode-btn.active{border-color:#00d4ff;color:#00d4ff;background:rgba(0,212,255,0.1)}
.theme-selector{display:flex;gap:8px;margin-bottom:15px}
.theme-btn{flex:1;padding:10px 8px;border:2px solid #333;border-radius:8px;background:#2a2a4e;color:#eee;cursor:pointer;font-size:0.85em;text-align:center}
.theme-btn.active{border-color:#00d4ff;color:#00d4ff}
.theme-btn .theme-name{font-weight:bold}
.theme-btn .theme-desc{font-size:0.75em;color:#888;margin-top:4px}
.custom-colors{padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;margin-top:15px}
.custom-colors.hidden{display:none}
</style>
</head>
<body>
<div class="container">
<h1>EpicWeatherBox</h1>
<div class="grid">
<div>
<div class="card preview-wrap">
<canvas id="preview" width="240" height="240"></canvas>
<div class="preview-info">240x240 Display Preview</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="cycleScreen()">Next Screen</button>
<button class="btn btn-secondary" onclick="refreshPreview()">Refresh</button>
</div>
</div>
<div class="card" style="margin-top:15px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h3 style="margin:0">Current Weather</h3>
<button class="btn btn-secondary" style="padding:4px 10px;font-size:0.8em" onclick="cycleWeatherLocation()">Next â–¶</button>
</div>
<div id="weather-display">Loading...</div>
</div>
</div>
<div>
<div class="card">
<div class="tabs">
<div class="tab active" data-tab="carousel">Carousel</div>
<div class="tab" data-tab="display">Display</div>
<div class="tab" data-tab="theme">Theme</div>
<div class="tab" data-tab="system">System</div>
</div>

<!-- CAROUSEL TAB -->
<div id="carousel" class="tab-content active">
<p id="carousel-desc" style="font-size:0.85em;color:#888;margin-bottom:12px">Drag to reorder screens.</p>
<div id="carousel-list" class="carousel-list"></div>
<div class="add-buttons">
<button class="btn btn-add" onclick="openModal('location')">+ Location</button>
<button class="btn btn-add" onclick="openModal('countdown')">+ Countdown</button>
<button class="btn btn-add" onclick="openModal('custom')">+ Custom Text</button>
</div>
<div class="carousel-counters">
<span>Locations: <span id="loc-count">0</span>/3</span>
<span>Countdowns: <span id="cd-count">0</span>/3</span>
<span>Custom: <span id="cust-count">0</span>/3</span>
</div>
<div class="btn-row" style="margin-top:15px">
<button class="btn btn-primary" onclick="saveCarousel()">Save Carousel</button>
</div>
<div id="carousel-status"></div>
</div>

<!-- DISPLAY TAB -->
<div id="display" class="tab-content">
<div class="form-group">
<label>Temperature Unit</label>
<select id="temp-unit">
<option value="f">Fahrenheit</option>
<option value="c">Celsius</option>
</select>
</div>
<div class="form-group">
<label>Screen Cycle (seconds)</label>
<input type="number" id="cycle-time" value="10" min="3" max="60">
</div>
<div class="form-group">
<label>Brightness</label>
<input type="range" id="brightness" min="10" max="100" value="80">
<span id="brightness-val">80%</span>
</div>
<div class="form-group" style="margin-top:15px">
<label style="margin-bottom:8px">Screen Options</label>
<div class="toggle-row">
<span>Show Forecast Screens</span>
<label class="toggle"><input type="checkbox" id="show-forecast" checked><span class="toggle-slider"></span></label>
</div>
<p style="font-size:0.75em;color:#666;margin-top:8px">When enabled, each location shows 3 screens (current + 2 forecast). When disabled, only current weather is shown.</p>
</div>
<div class="btn-row">
<button class="btn btn-primary" onclick="saveDisplay()">Save Settings</button>
</div>
<div id="display-status"></div>
</div>

<!-- THEME TAB -->
<div id="theme" class="tab-content">
<div class="form-group">
<label>Select Theme</label>
<div class="theme-selector">
<div class="theme-btn active" data-theme="0"><div class="theme-name">Classic</div><div class="theme-desc">Original colors</div></div>
<div class="theme-btn" data-theme="1"><div class="theme-name">Minecraft</div><div class="theme-desc">Blocky earth tones</div></div>
<div class="theme-btn" data-theme="2"><div class="theme-name">Custom</div><div class="theme-desc">Your colors</div></div>
</div>
</div>
<div class="form-group">
<label>Theme Mode</label>
<div class="mode-selector">
<div class="mode-btn active" data-mode="0">Auto</div>
<div class="mode-btn" data-mode="1">Dark</div>
<div class="mode-btn" data-mode="2">Light</div>
</div>
<p style="font-size:0.75em;color:#666;margin-top:4px">Auto uses dark at night, light during day.</p>
</div>
<div id="custom-colors" class="custom-colors hidden">
<div class="form-group">
<label>Start From</label>
<div class="btn-row">
<button class="btn btn-secondary" onclick="loadThemeColors(0)">Load Classic</button>
<button class="btn btn-secondary" onclick="loadThemeColors(1)">Load Minecraft</button>
<button class="btn btn-secondary" style="background:#633" onclick="clearCustomTheme()">Clear All</button>
</div>
</div>
<div class="color-group">
<div class="color-group-title">Dark Mode - Background Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements on the main screen background</p>
<div class="color-row"><span class="color-label">Background</span><input type="color" class="color-preview" id="dark-bg"><input type="text" class="color-input" id="dark-bg-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Primary Text</span><input type="color" class="color-preview" id="dark-text"><input type="text" class="color-input" id="dark-text-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Time &amp; Headers</span><input type="color" class="color-preview" id="dark-cyan"><input type="text" class="color-input" id="dark-cyan-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">High Temp</span><input type="color" class="color-preview" id="dark-orange"><input type="text" class="color-input" id="dark-orange-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Low Temp</span><input type="color" class="color-preview" id="dark-blue"><input type="text" class="color-input" id="dark-blue-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Secondary Text</span><input type="color" class="color-preview" id="dark-gray"><input type="text" class="color-input" id="dark-gray-hex" maxlength="7"></div>
</div>
<div class="color-group">
<div class="color-group-title">Dark Mode - Card Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements inside forecast cards and footer bars</p>
<div class="color-row"><span class="color-label">Card Background</span><input type="color" class="color-preview" id="dark-card"><input type="text" class="color-input" id="dark-card-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Text</span><input type="color" class="color-preview" id="dark-textOnCard"><input type="text" class="color-input" id="dark-textOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Accents</span><input type="color" class="color-preview" id="dark-cyanOnCard"><input type="text" class="color-input" id="dark-cyanOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card High Temp</span><input type="color" class="color-preview" id="dark-orangeOnCard"><input type="text" class="color-input" id="dark-orangeOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Low Temp</span><input type="color" class="color-preview" id="dark-blueOnCard"><input type="text" class="color-input" id="dark-blueOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Secondary</span><input type="color" class="color-preview" id="dark-grayOnCard"><input type="text" class="color-input" id="dark-grayOnCard-hex" maxlength="7"></div>
</div>
<div class="color-group">
<div class="color-group-title">Light Mode - Background Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements on the main screen background</p>
<div class="color-row"><span class="color-label">Background</span><input type="color" class="color-preview" id="light-bg"><input type="text" class="color-input" id="light-bg-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Primary Text</span><input type="color" class="color-preview" id="light-text"><input type="text" class="color-input" id="light-text-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Time &amp; Headers</span><input type="color" class="color-preview" id="light-cyan"><input type="text" class="color-input" id="light-cyan-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">High Temp</span><input type="color" class="color-preview" id="light-orange"><input type="text" class="color-input" id="light-orange-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Low Temp</span><input type="color" class="color-preview" id="light-blue"><input type="text" class="color-input" id="light-blue-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Secondary Text</span><input type="color" class="color-preview" id="light-gray"><input type="text" class="color-input" id="light-gray-hex" maxlength="7"></div>
</div>
<div class="color-group">
<div class="color-group-title">Light Mode - Card Colors</div>
<p style="font-size:0.7em;color:#666;margin-bottom:8px">Colors for elements inside forecast cards and footer bars</p>
<div class="color-row"><span class="color-label">Card Background</span><input type="color" class="color-preview" id="light-card"><input type="text" class="color-input" id="light-card-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Text</span><input type="color" class="color-preview" id="light-textOnCard"><input type="text" class="color-input" id="light-textOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Accents</span><input type="color" class="color-preview" id="light-cyanOnCard"><input type="text" class="color-input" id="light-cyanOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card High Temp</span><input type="color" class="color-preview" id="light-orangeOnCard"><input type="text" class="color-input" id="light-orangeOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Low Temp</span><input type="color" class="color-preview" id="light-blueOnCard"><input type="text" class="color-input" id="light-blueOnCard-hex" maxlength="7"></div>
<div class="color-row"><span class="color-label">Card Secondary</span><input type="color" class="color-preview" id="light-grayOnCard"><input type="text" class="color-input" id="light-grayOnCard-hex" maxlength="7"></div>
</div>
</div>
<div class="btn-row" style="margin-top:15px">
<button class="btn btn-primary" onclick="saveTheme()">Save Theme</button>
</div>
<div id="theme-status"></div>
</div>

<!-- SYSTEM TAB -->
<div id="system" class="tab-content">
<div class="form-group">
<label>Device Info</label>
<div id="device-info">Loading...</div>
</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="refreshWeather()">Refresh Weather</button>
<button class="btn btn-secondary" onclick="location.href='/update'">Firmware Update</button>
<button class="btn btn-secondary" style="background:#c33" onclick="if(confirm('Reboot?'))location.href='/reboot'">Reboot</button>
</div>
<div class="form-group" style="margin-top:20px">
<label>API Endpoints</label>
<div class="info-box"><span class="info-label">/api/weather</span><a href="/api/weather" class="info-value" style="text-decoration:none">Weather data</a></div>
<div class="info-box"><span class="info-label">/api/config</span><a href="/api/config" class="info-value" style="text-decoration:none">Location config</a></div>
<div class="info-box"><span class="info-label">/api/status</span><a href="/api/status" class="info-value" style="text-decoration:none">Device status</a></div>
</div>
<div class="form-group" style="margin-top:15px">
<label>Project Links</label>
<div class="info-box"><span class="info-label">GitHub</span><a href="https://github.com/ryanmaule/epicweatherbox" target="_blank" class="info-value" style="text-decoration:none">Source &amp; Docs</a></div>
<div class="info-box"><span class="info-label">Releases</span><a href="https://github.com/ryanmaule/epicweatherbox/releases" target="_blank" class="info-value" style="text-decoration:none">Download firmware</a></div>
<div class="info-box"><span class="info-label">Issues</span><a href="https://github.com/ryanmaule/epicweatherbox/issues" target="_blank" class="info-value" style="text-decoration:none">Report bugs</a></div>
</div>
</div>
</div>
</div>
</div>
<div class="links">
<a href="https://github.com/ryanmaule/epicweatherbox" target="_blank">GitHub</a>
<a href="/api/safemode" style="color:#f90">Safe Mode</a>
<a href="/api/reprovision" style="color:#6cf" onclick="return confirm('Reload Admin will refresh the admin UI and reboot. Continue?')">Reload Admin</a>
<a href="/reset" style="color:#f66" onclick="return confirm('Factory Reset will clear WiFi settings and reboot. Continue?')">Factory Reset</a>
</div>
</div>

<!-- MODALS -->
<div id="modal-location" class="modal">
<div class="modal-content">
<h3>Add Location</h3>
<div class="form-group">
<label>Location Name</label>
<input type="text" id="new-loc-name" placeholder="e.g., Seattle">
</div>
<div class="form-row">
<div class="form-group">
<label>Latitude</label>
<input type="number" id="new-loc-lat" step="0.0001" placeholder="47.6062">
</div>
<div class="form-group">
<label>Longitude</label>
<input type="number" id="new-loc-lon" step="0.0001" placeholder="-122.3321">
</div>
</div>
<button class="btn btn-secondary" onclick="useMyLocationForNew()" style="width:100%">Use My Location</button>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('location')">Cancel</button>
<button class="btn btn-primary" onclick="addLocation()">Add</button>
</div>
</div>
</div>

<div id="modal-countdown" class="modal">
<div class="modal-content">
<h3>Add Countdown</h3>
<div class="form-group">
<label>Event Type</label>
<select id="new-cd-type" onchange="updateCountdownFields()">
<option value="0">Birthday</option>
<option value="1">Easter</option>
<option value="2">Halloween</option>
<option value="3">Valentine's Day</option>
<option value="4">Christmas</option>
<option value="5">Custom Date</option>
</select>
</div>
<div class="form-group" id="cd-title-group">
<label>Title</label>
<input type="text" id="new-cd-title" maxlength="31" placeholder="e.g., Mom's Birthday">
</div>
<div class="form-row" id="cd-date-group">
<div class="form-group">
<label>Month</label>
<select id="new-cd-month">
<option value="1">January</option><option value="2">February</option><option value="3">March</option>
<option value="4">April</option><option value="5">May</option><option value="6">June</option>
<option value="7">July</option><option value="8">August</option><option value="9">September</option>
<option value="10">October</option><option value="11">November</option><option value="12">December</option>
</select>
</div>
<div class="form-group">
<label>Day</label>
<input type="number" id="new-cd-day" min="1" max="31" value="1">
</div>
</div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('countdown')">Cancel</button>
<button class="btn btn-primary" onclick="addCountdown()">Add</button>
</div>
</div>
</div>

<div id="modal-custom" class="modal">
<div class="modal-content">
<h3>Add Custom Text Screen</h3>
<div class="form-group">
<label>Header (max 16 chars)</label>
<input type="text" id="new-cust-header" maxlength="16" placeholder="e.g., Quote">
</div>
<div class="form-group">
<label>Body Text (max 80 chars)</label>
<textarea id="new-cust-body" maxlength="80" rows="3" placeholder="Your message..."></textarea>
<div style="font-size:0.75em;color:#666;margin-top:4px"><span id="new-body-count">0</span>/80</div>
</div>
<div class="form-group">
<label>Footer (max 30 chars)</label>
<input type="text" id="new-cust-footer" maxlength="30" placeholder="e.g., Have a great day!">
</div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('custom')">Cancel</button>
<button class="btn btn-primary" onclick="addCustomScreen()">Add</button>
</div>
</div>
</div>

<script>
// Data storage
let carouselItems = [];
let locations = [];
let countdowns = [];
let customScreens = [];
let currentScreen = 0;
let currentWeatherLocationIdx = 0;
let weatherData = null;
let themeData = null;

const canvas = document.getElementById('preview');
const ctx = canvas.getContext('2d');

const ICONS = {
  location: 'ðŸ“',
  countdown: {
    0: 'ðŸŽ‚', // Birthday
    1: 'ðŸ°', // Easter
    2: 'ðŸŽƒ', // Halloween
    3: 'â¤ï¸', // Valentine
    4: 'ðŸŽ„', // Christmas
    5: 'ðŸ“…'  // Custom
  },
  custom: 'ðŸ“'
};

const EVENT_NAMES = ['Birthday', 'Easter', 'Halloween', 'Valentine\'s', 'Christmas', 'Custom'];
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  };
});

// Brightness slider
document.getElementById('brightness').oninput = e => {
  document.getElementById('brightness-val').textContent = e.target.value + '%';
};

// Body character counter for new custom screen
document.getElementById('new-cust-body').oninput = e => {
  document.getElementById('new-body-count').textContent = e.target.value.length;
};

// Modal handling
function openModal(type) {
  document.getElementById('modal-' + type).classList.add('active');
  if (type === 'countdown') updateCountdownFields();
}

function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('active');
  // Clear fields
  if (type === 'location') {
    document.getElementById('new-loc-name').value = '';
    document.getElementById('new-loc-lat').value = '';
    document.getElementById('new-loc-lon').value = '';
  } else if (type === 'countdown') {
    document.getElementById('new-cd-type').value = '0';
    document.getElementById('new-cd-title').value = '';
    document.getElementById('new-cd-month').value = '1';
    document.getElementById('new-cd-day').value = '1';
  } else if (type === 'custom') {
    document.getElementById('new-cust-header').value = '';
    document.getElementById('new-cust-body').value = '';
    document.getElementById('new-cust-footer').value = '';
    document.getElementById('new-body-count').textContent = '0';
  }
}

function updateCountdownFields() {
  const type = parseInt(document.getElementById('new-cd-type').value);
  const titleGroup = document.getElementById('cd-title-group');
  const dateGroup = document.getElementById('cd-date-group');

  // Show/hide title based on type
  if (type === 0 || type === 5) { // Birthday or Custom
    titleGroup.style.display = 'block';
  } else {
    titleGroup.style.display = 'none';
  }

  // Show/hide date based on type (Easter is calculated)
  if (type === 1) { // Easter
    dateGroup.style.display = 'none';
  } else if (type === 2) { // Halloween - Oct 31
    dateGroup.style.display = 'none';
  } else if (type === 3) { // Valentine - Feb 14
    dateGroup.style.display = 'none';
  } else if (type === 4) { // Christmas - Dec 25
    dateGroup.style.display = 'none';
  } else {
    dateGroup.style.display = 'grid';
  }
}

// Render carousel list
function renderCarousel() {
  const list = document.getElementById('carousel-list');
  list.innerHTML = '';

  let locCount = 0, cdCount = 0, custCount = 0;

  carouselItems.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'carousel-item';
    div.draggable = true;
    div.dataset.index = idx;

    let icon, title, desc;
    if (item.type === 0) { // Location
      const loc = locations[item.dataIndex] || {};
      icon = ICONS.location;
      title = loc.name || 'Location ' + (item.dataIndex + 1);
      desc = `Lat: ${loc.lat?.toFixed(4) || '?'}, Lon: ${loc.lon?.toFixed(4) || '?'}`;
      locCount++;
    } else if (item.type === 1) { // Countdown
      const cd = countdowns[item.dataIndex] || {};
      icon = ICONS.countdown[cd.type] || 'ðŸ“…';
      title = cd.title || EVENT_NAMES[cd.type] || 'Countdown';
      if (cd.type === 1) {
        desc = 'Easter (calculated)';
      } else {
        desc = MONTH_NAMES[(cd.month || 1) - 1] + ' ' + (cd.day || 1);
      }
      cdCount++;
    } else { // Custom
      const cust = customScreens[item.dataIndex] || {};
      icon = ICONS.custom;
      title = cust.header || 'Custom Screen';
      desc = (cust.body || '').substring(0, 40) + (cust.body?.length > 40 ? '...' : '');
      custCount++;
    }

    div.innerHTML = `
      <span class="drag-handle">â˜°</span>
      <span class="item-icon">${icon}</span>
      <div class="item-info">
        <div class="item-title">${escapeHtml(title)}</div>
        <div class="item-desc">${escapeHtml(desc)}</div>
      </div>
      <button class="item-remove" onclick="removeCarouselItem(${idx})">Ã—</button>
    `;

    // Drag events
    div.ondragstart = e => {
      e.dataTransfer.setData('text/plain', idx);
      div.classList.add('dragging');
    };
    div.ondragend = () => div.classList.remove('dragging');
    div.ondragover = e => e.preventDefault();
    div.ondrop = e => {
      e.preventDefault();
      const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
      const toIdx = idx;
      if (fromIdx !== toIdx) {
        const item = carouselItems.splice(fromIdx, 1)[0];
        carouselItems.splice(toIdx, 0, item);
        renderCarousel();
      }
    };

    list.appendChild(div);
  });

  document.getElementById('loc-count').textContent = locCount;
  document.getElementById('cd-count').textContent = cdCount;
  document.getElementById('cust-count').textContent = custCount;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// Add items
function addLocation() {
  if (locations.length >= 3) {
    alert('Maximum 3 locations allowed');
    return;
  }
  const name = document.getElementById('new-loc-name').value.trim();
  const lat = parseFloat(document.getElementById('new-loc-lat').value);
  const lon = parseFloat(document.getElementById('new-loc-lon').value);

  if (!name || isNaN(lat) || isNaN(lon)) {
    alert('Please fill in all fields');
    return;
  }

  const idx = locations.length;
  locations.push({ name, lat, lon, enabled: true });
  carouselItems.push({ type: 0, dataIndex: idx });
  closeModal('location');
  renderCarousel();
}

function addCountdown() {
  if (countdowns.length >= 3) {
    alert('Maximum 3 countdowns allowed');
    return;
  }
  const type = parseInt(document.getElementById('new-cd-type').value);
  let title = document.getElementById('new-cd-title').value.trim();
  let month = parseInt(document.getElementById('new-cd-month').value);
  let day = parseInt(document.getElementById('new-cd-day').value);

  // Set defaults for preset types
  if (type === 1) { month = 4; day = 1; title = 'Easter'; } // Easter - date calculated
  else if (type === 2) { month = 10; day = 31; title = 'Halloween'; }
  else if (type === 3) { month = 2; day = 14; title = 'Valentine\'s Day'; }
  else if (type === 4) { month = 12; day = 25; title = 'Christmas'; }
  else if (!title) {
    alert('Please enter a title');
    return;
  }

  const idx = countdowns.length;
  countdowns.push({ type, month, day, title });
  carouselItems.push({ type: 1, dataIndex: idx });
  closeModal('countdown');
  renderCarousel();
}

function addCustomScreen() {
  if (customScreens.length >= 3) {
    alert('Maximum 3 custom screens allowed');
    return;
  }
  const header = document.getElementById('new-cust-header').value.trim();
  const body = document.getElementById('new-cust-body').value.trim();
  const footer = document.getElementById('new-cust-footer').value.trim();

  if (!body) {
    alert('Please enter body text');
    return;
  }

  const idx = customScreens.length;
  customScreens.push({ header, body, footer });
  carouselItems.push({ type: 2, dataIndex: idx });
  closeModal('custom');
  renderCarousel();
}

function removeCarouselItem(idx) {
  if (!confirm('Remove this item?')) return;

  const item = carouselItems[idx];
  carouselItems.splice(idx, 1);

  // Don't remove from data arrays - just from carousel
  // The dataIndex still points to the correct data

  renderCarousel();
}

function useMyLocationForNew() {
  if (!navigator.geolocation) {
    alert('Geolocation not supported');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    document.getElementById('new-loc-lat').value = pos.coords.latitude.toFixed(4);
    document.getElementById('new-loc-lon').value = pos.coords.longitude.toFixed(4);
  }, () => alert('Could not get location'));
}

// Save carousel
async function saveCarousel() {
  // Rebuild data arrays to only include items that are in the carousel
  // and fix dataIndex values to match their actual array positions
  const usedLocs = [];
  const usedCds = [];
  const usedCusts = [];
  const newCarousel = [];

  carouselItems.forEach(item => {
    if (item.type === 0) { // Location
      const loc = locations[item.dataIndex];
      if (loc) {
        const newIdx = usedLocs.length;
        usedLocs.push(loc);
        newCarousel.push({ type: 0, dataIndex: newIdx });
      }
    } else if (item.type === 1) { // Countdown
      const cd = countdowns[item.dataIndex];
      if (cd) {
        const newIdx = usedCds.length;
        usedCds.push(cd);
        newCarousel.push({ type: 1, dataIndex: newIdx });
      }
    } else if (item.type === 2) { // Custom
      const cust = customScreens[item.dataIndex];
      if (cust) {
        const newIdx = usedCusts.length;
        usedCusts.push(cust);
        newCarousel.push({ type: 2, dataIndex: newIdx });
      }
    }
  });

  const data = {
    carousel: newCarousel,
    locations: usedLocs,
    countdowns: usedCds,
    customScreens: usedCusts
  };

  try {
    const r = await fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await r.json();
    showStatus('carousel-status', result.success ? 'success' : 'error', result.message);
    if (result.success) setTimeout(() => location.reload(), 2000);
  } catch (e) {
    showStatus('carousel-status', 'error', 'Failed to save');
  }
}

// Load initial data
async function loadData() {
  try {
    const [weather, status, config, themes] = await Promise.all([
      fetch('/api/weather').then(r => r.json()),
      fetch('/api/status').then(r => r.json()),
      fetch('/api/config').then(r => r.json()).catch(() => ({})),
      fetch('/api/themes').then(r => r.json()).catch(() => ({}))
    ]);
    updateWeatherDisplay(weather);
    updateDeviceInfo(status);
    updateConfig(config);
    updateThemes(themes);
    drawPreview(weather);
  } catch (e) { console.error(e); }
}

function updateWeatherDisplay(data) {
  weatherData = data;  // Store for cycling

  // Use locations array if available, otherwise fall back to primary
  let w = null;
  if (data.locations && data.locations.length > 0) {
    if (currentWeatherLocationIdx >= data.locations.length) {
      currentWeatherLocationIdx = 0;
    }
    w = data.locations[currentWeatherLocationIdx];
  } else if (data.primary && data.primary.valid) {
    w = data.primary;
  }

  if (!w || !w.valid) {
    document.getElementById('weather-display').innerHTML = '<div class="status error">Weather unavailable</div>';
    return;
  }

  let html = `<div class="weather-now">
    <div class="weather-icon">${w.current.icon}</div>
    <div class="weather-temp">${Math.round(w.current.temperature)}Â°</div>
    <div class="weather-cond">${w.current.condition} - ${w.location}</div>
  </div><div class="forecast">`;
  w.forecast.slice(0, 5).forEach(d => {
    html += `<div class="forecast-day"><div class="day">${d.day}</div><div class="icon">${d.icon}</div><div class="temp">${Math.round(d.tempMax)}Â°</div></div>`;
  });
  html += '</div>';
  document.getElementById('weather-display').innerHTML = html;
}

function cycleWeatherLocation() {
  if (!weatherData || !weatherData.locations || weatherData.locations.length <= 1) {
    return; // Nothing to cycle
  }
  currentWeatherLocationIdx = (currentWeatherLocationIdx + 1) % weatherData.locations.length;
  updateWeatherDisplay(weatherData);
}

function updateDeviceInfo(s) {
  document.getElementById('device-info').innerHTML = `
    <div class="info-box"><span class="info-label">Version</span><span class="info-value" id="version-info">${s.version}</span></div>
    <div class="info-box"><span class="info-label">IP Address</span><span class="info-value">${s.ip}</span></div>
    <div class="info-box"><span class="info-label">Uptime</span><span class="info-value">${Math.floor(s.uptime / 60)}m ${s.uptime % 60}s</span></div>
    <div class="info-box"><span class="info-label">Free RAM</span><span class="info-value">${(s.heap / 1024).toFixed(1)} KB</span></div>
    <div class="info-box"><span class="info-label">WiFi Signal</span><span class="info-value">${s.rssi} dBm</span></div>`;
  checkForUpdate(s.version);
}

function compareVersions(v1, v2) {
  const p1 = v1.replace(/^v/, '').split('.').map(Number);
  const p2 = v2.replace(/^v/, '').split('.').map(Number);
  for (let i = 0; i < 3; i++) {
    const a = p1[i] || 0, b = p2[i] || 0;
    if (a < b) return -1;
    if (a > b) return 1;
  }
  return 0;
}

async function checkForUpdate(currentVersion) {
  try {
    const r = await fetch('https://api.github.com/repos/ryanmaule/epicweatherbox/releases/latest');
    if (!r.ok) return;
    const data = await r.json();
    const latestVersion = data.tag_name;
    if (compareVersions(currentVersion, latestVersion) < 0) {
      const versionEl = document.getElementById('version-info');
      if (versionEl) {
        versionEl.innerHTML = currentVersion +
          ` <a href="${data.html_url}" target="_blank" class="update-badge">${latestVersion} available</a>`;
      }
    }
  } catch (e) { /* Ignore errors - update check is optional */ }
}

function updateConfig(c) {
  // Load carousel items
  if (c.carousel && Array.isArray(c.carousel)) {
    carouselItems = c.carousel;
  } else {
    carouselItems = [];
  }

  // Load locations
  if (c.locations && Array.isArray(c.locations)) {
    locations = c.locations;
  } else {
    // Legacy format
    locations = [];
    if (c.primary) {
      locations.push({ name: c.primary.name, lat: c.primary.lat, lon: c.primary.lon, enabled: true });
    }
    if (c.secondary && c.secondary.enabled) {
      locations.push({ name: c.secondary.name, lat: c.secondary.lat, lon: c.secondary.lon, enabled: true });
    }
    // Create default carousel from locations
    if (carouselItems.length === 0) {
      locations.forEach((_, i) => carouselItems.push({ type: 0, dataIndex: i }));
    }
  }

  // Load countdowns
  if (c.countdowns && Array.isArray(c.countdowns)) {
    countdowns = c.countdowns;
  } else {
    countdowns = [];
  }

  // Load custom screens
  if (c.customScreens && Array.isArray(c.customScreens)) {
    customScreens = c.customScreens;
  } else if (c.customScreenEnabled && c.customScreenBody) {
    // Legacy single custom screen
    customScreens = [{
      header: c.customScreenHeader || '',
      body: c.customScreenBody || '',
      footer: c.customScreenFooter || ''
    }];
  } else {
    customScreens = [];
  }

  // Display settings
  if (c.display) {
    document.getElementById('temp-unit').value = c.display.unit || 'f';
    document.getElementById('cycle-time').value = c.display.cycle || 10;
    document.getElementById('brightness').value = c.display.brightness || 80;
    document.getElementById('brightness-val').textContent = (c.display.brightness || 80) + '%';
  }

  // Load showForecast setting
  const showForecastEl = document.getElementById('show-forecast');
  if (showForecastEl) {
    showForecastEl.checked = c.showForecast !== false;  // Default to true
    updateCarouselDescription();
  }

  renderCarousel();
}

function drawPreview(data) {
  weatherData = data;  // Store for use
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, 240, 240);

  // Get weather data - prefer locations array
  let w = null;
  if (data && data.locations && data.locations.length > 0 && data.locations[0].valid) {
    w = data.locations[0];
  } else if (data && data.primary && data.primary.valid) {
    w = data.primary;
  }

  if (!w) {
    ctx.fillStyle = '#666';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('No weather data', 120, 120);
    return;
  }

  // Draw based on current screen state
  drawScreenByIndex(currentScreen, w);
}

function drawCurrentWeather(w) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);
  ctx.textAlign = 'center';
  ctx.fillStyle = '#00d4ff';
  ctx.font = 'bold 14px sans-serif';
  ctx.fillText(w.location, 120, 25);
  ctx.font = '60px sans-serif';
  ctx.fillText(w.current.icon, 120, 100);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 48px sans-serif';
  ctx.fillText(Math.round(w.current.temperature) + 'Â°', 120, 160);
  ctx.fillStyle = '#aaa';
  ctx.font = '16px sans-serif';
  ctx.fillText(w.current.condition, 120, 185);
  ctx.font = '12px sans-serif';
  ctx.fillText('Wind: ' + w.current.windSpeed + ' mph', 120, 210);
  const now = new Date();
  ctx.fillStyle = '#666';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 120, 232);
}

function cycleScreen() {
  const showForecast = document.getElementById('show-forecast')?.checked !== false;

  // Count total screens based on carousel items
  let totalScreens = 0;
  carouselItems.forEach(item => {
    if (item.type === 0) totalScreens += showForecast ? 3 : 1; // Location = 3 or 1 screens
    else totalScreens += 1; // Countdown or Custom = 1 screen
  });
  if (totalScreens === 0) totalScreens = 1;

  currentScreen = (currentScreen + 1) % totalScreens;
  if (weatherData) {
    // Get weather data for preview
    let w = null;
    if (weatherData.locations && weatherData.locations.length > 0 && weatherData.locations[0].valid) {
      w = weatherData.locations[0];
    } else if (weatherData.primary && weatherData.primary.valid) {
      w = weatherData.primary;
    }
    if (w) drawScreenByIndex(currentScreen, w);
  }
}

function drawScreenByIndex(screenIdx, weather) {
  const showForecast = document.getElementById('show-forecast')?.checked !== false;

  // Map screen index to carousel item
  let idx = 0;
  for (let i = 0; i < carouselItems.length; i++) {
    const item = carouselItems[i];
    if (item.type === 0) {
      // Location: 3 screens (current, forecast 1-3, forecast 4-6) or just 1
      const screensForLoc = showForecast ? 3 : 1;
      if (screenIdx < idx + screensForLoc) {
        const subScreen = screenIdx - idx;
        const locIdx = item.dataIndex;
        // Get weather for this location
        let w = weather;
        if (weatherData && weatherData.locations && weatherData.locations[locIdx]) {
          w = weatherData.locations[locIdx];
        }
        if (subScreen === 0) drawCurrentWeather(w);
        else drawForecastPreview(w, subScreen - 1);
        return;
      }
      idx += screensForLoc;
    } else if (item.type === 1) {
      // Countdown: 1 screen
      if (screenIdx === idx) {
        const cd = countdowns[item.dataIndex];
        if (cd) drawCountdownPreview(cd);
        return;
      }
      idx += 1;
    } else if (item.type === 2) {
      // Custom: 1 screen
      if (screenIdx === idx) {
        const cust = customScreens[item.dataIndex];
        if (cust) drawCustomPreview(cust);
        return;
      }
      idx += 1;
    }
  }
  // Fallback to current weather
  drawCurrentWeather(weather);
}

function drawForecastPreview(w, forecastSet) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);
  ctx.textAlign = 'center';

  // Header
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);
  ctx.textAlign = 'right';
  ctx.fillStyle = '#888';
  ctx.fillText('Forecast', 230, 20);

  // Location
  ctx.textAlign = 'center';
  ctx.fillStyle = '#00d4ff';
  ctx.font = 'bold 16px sans-serif';
  ctx.fillText(w.location, 120, 45);

  // Forecast days
  const startDay = forecastSet * 3;
  const days = w.forecast.slice(startDay, startDay + 3);

  days.forEach((d, i) => {
    const y = 70 + i * 55;
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.fillRect(20, y, 200, 48);

    ctx.fillStyle = '#888';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(d.day, 30, y + 18);

    ctx.font = '24px sans-serif';
    ctx.fillText(d.icon, 30, y + 42);

    ctx.fillStyle = '#fff';
    ctx.font = 'bold 24px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(d.tempMax) + 'Â°', 210, y + 35);
  });

  // Dots
  drawDots(forecastSet + 1, 3);
}

function drawCountdownPreview(cd) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);
  ctx.textAlign = 'center';

  // Header
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);
  ctx.textAlign = 'right';
  ctx.fillStyle = '#888';
  ctx.fillText('Countdown', 230, 20);

  // Icon
  const icon = ICONS.countdown[cd.type] || 'ðŸ“…';
  ctx.font = '48px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(icon, 120, 85);

  // Title
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 20px sans-serif';
  ctx.fillText(cd.title || EVENT_NAMES[cd.type] || 'Event', 120, 125);

  // Calculate days
  const targetDate = getEventDate(cd);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const diffTime = targetDate.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  ctx.font = 'bold 36px sans-serif';
  ctx.fillStyle = '#00d4ff';
  ctx.fillText(diffDays + ' days', 120, 175);

  // Date
  ctx.font = '14px sans-serif';
  ctx.fillStyle = '#888';
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  ctx.fillText(dayNames[targetDate.getDay()] + ', ' + MONTH_NAMES[targetDate.getMonth()] + ' ' + targetDate.getDate(), 120, 200);
}

function drawCustomPreview(cust) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);

  // Header
  ctx.fillStyle = '#00d4ff';
  ctx.font = '12px sans-serif';
  const now = new Date();
  ctx.textAlign = 'left';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 10, 20);
  ctx.textAlign = 'right';
  ctx.fillStyle = '#888';
  if (cust.header) {
    ctx.fillText('â˜… ' + cust.header, 230, 20);
  }

  // Body text
  ctx.textAlign = 'center';
  ctx.fillStyle = '#fff';
  const bodyLen = (cust.body || '').length;
  if (bodyLen <= 40) {
    ctx.font = 'bold 18px sans-serif';
  } else if (bodyLen <= 80) {
    ctx.font = 'bold 14px sans-serif';
  } else {
    ctx.font = '12px sans-serif';
  }

  // Simple word wrap
  const words = (cust.body || '').split(' ');
  let lines = [];
  let currentLine = '';
  words.forEach(word => {
    const testLine = currentLine ? currentLine + ' ' + word : word;
    if (ctx.measureText(testLine).width > 200) {
      if (currentLine) lines.push(currentLine);
      currentLine = word;
    } else {
      currentLine = testLine;
    }
  });
  if (currentLine) lines.push(currentLine);

  const lineHeight = bodyLen <= 40 ? 28 : (bodyLen <= 80 ? 22 : 18);
  const startY = 120 - (lines.length - 1) * lineHeight / 2;
  lines.forEach((line, i) => {
    ctx.fillText(line, 120, startY + i * lineHeight);
  });

  // Footer
  if (cust.footer) {
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    const footerWidth = ctx.measureText(cust.footer).width + 20;
    ctx.fillRect(120 - footerWidth / 2, 205, footerWidth, 25);
    ctx.fillStyle = '#00d4ff';
    ctx.font = '12px sans-serif';
    ctx.fillText(cust.footer, 120, 222);
  }
}

function getEventDate(cd) {
  const now = new Date();
  let year = now.getFullYear();
  let month = cd.month - 1;
  let day = cd.day;

  // Easter calculation
  if (cd.type === 1) {
    const easter = calculateEaster(year);
    month = easter.month;
    day = easter.day;
  }

  let date = new Date(year, month, day);
  // If date has passed, use next year
  if (date < now) {
    year++;
    if (cd.type === 1) {
      const easter = calculateEaster(year);
      month = easter.month;
      day = easter.day;
    }
    date = new Date(year, month, day);
  }
  return date;
}

function calculateEaster(year) {
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  return { month, day };
}

function drawDots(current, total) {
  const dotSpacing = 12;
  const startX = 120 - (total - 1) * dotSpacing / 2;
  for (let i = 0; i < total; i++) {
    ctx.beginPath();
    ctx.arc(startX + i * dotSpacing, 232, 3, 0, Math.PI * 2);
    ctx.fillStyle = i === current ? '#fff' : '#444';
    ctx.fill();
  }
}

function refreshPreview() {
  fetch('/api/weather').then(r => r.json()).then(drawPreview);
}

async function saveDisplay() {
  const showForecast = document.getElementById('show-forecast').checked;
  const data = {
    display: {
      unit: document.getElementById('temp-unit').value,
      cycle: parseInt(document.getElementById('cycle-time').value),
      brightness: parseInt(document.getElementById('brightness').value)
    },
    showForecast: showForecast
  };
  try {
    const r = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    const result = await r.json();
    showStatus('display-status', result.success ? 'success' : 'error', result.message);
    updateCarouselDescription();
  } catch (e) { showStatus('display-status', 'error', 'Failed to save'); }
}

function updateCarouselDescription() {
  // No longer needed - description is now static
}

async function refreshWeather() {
  try {
    const r = await fetch('/api/weather/refresh');
    const result = await r.json();
    if (result.success) loadData();
  } catch (e) {}
}

function showStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.textContent = msg;
  setTimeout(() => el.textContent = '', 5000);
}

// RGB565 conversion functions
// Note: Display uses RGB565 format (R in high bits 11-15, B in low bits 0-4)
function rgb565ToHex(val) {
  const r = ((val >> 11) & 0x1F) << 3;
  const g = ((val >> 5) & 0x3F) << 2;
  const b = (val & 0x1F) << 3;
  return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
}

function hexToRgb565(hex) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return ((r >> 3) << 11) | ((g >> 2) << 5) | (b >> 3);
}

// Theme UI handlers
const COLOR_FIELDS = ['bg', 'card', 'text', 'textOnCard', 'cyan', 'cyanOnCard', 'orange', 'orangeOnCard', 'blue', 'blueOnCard', 'gray', 'grayOnCard'];

function updateThemes(data) {
  themeData = data;
  if (!data || typeof data.activeTheme === 'undefined') return;

  // Update theme selector
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.theme) === data.activeTheme);
  });

  // Update mode selector
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.mode) === data.themeMode);
  });

  // Show/hide custom colors section
  const customSection = document.getElementById('custom-colors');
  customSection.classList.toggle('hidden', data.activeTheme !== 2);

  // Load custom theme colors into pickers
  if (data.themes && data.themes[2]) {
    loadColorGroup('dark', data.themes[2].dark);
    loadColorGroup('light', data.themes[2].light);
  }
}

function loadColorGroup(mode, colors) {
  if (!colors) return;
  COLOR_FIELDS.forEach(field => {
    const picker = document.getElementById(`${mode}-${field}`);
    const hex = document.getElementById(`${mode}-${field}-hex`);
    if (picker && hex && colors[field] !== undefined) {
      const hexVal = rgb565ToHex(colors[field]);
      picker.value = hexVal;
      hex.value = hexVal;
    }
  });
}

// Load colors from a built-in theme (0=Classic, 1=Minecraft)
function loadThemeColors(themeIndex) {
  if (!themeData || !themeData.themes || !themeData.themes[themeIndex]) {
    showStatus('theme-status', 'error', 'Theme data not available');
    return;
  }
  const theme = themeData.themes[themeIndex];
  loadColorGroup('dark', theme.dark);
  loadColorGroup('light', theme.light);
  showStatus('theme-status', 'success', `Loaded ${theme.name} colors`);
}

// Clear all custom theme colors to black
function clearCustomTheme() {
  if (!confirm('Clear all custom colors to black?')) return;
  const black = '#000000';
  COLOR_FIELDS.forEach(field => {
    ['dark', 'light'].forEach(mode => {
      const picker = document.getElementById(`${mode}-${field}`);
      const hex = document.getElementById(`${mode}-${field}-hex`);
      if (picker && hex) {
        picker.value = black;
        hex.value = black;
      }
    });
  });
  showStatus('theme-status', 'success', 'Colors cleared');
}

// Theme selector click handlers
document.querySelectorAll('.theme-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const customSection = document.getElementById('custom-colors');
    customSection.classList.toggle('hidden', btn.dataset.theme !== '2');
  };
});

// Mode selector click handlers
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  };
});

// Color picker sync (color input <-> hex input)
COLOR_FIELDS.forEach(field => {
  ['dark', 'light'].forEach(mode => {
    const picker = document.getElementById(`${mode}-${field}`);
    const hex = document.getElementById(`${mode}-${field}-hex`);
    if (picker && hex) {
      picker.oninput = () => { hex.value = picker.value; };
      hex.oninput = () => {
        if (/^#[0-9A-Fa-f]{6}$/.test(hex.value)) {
          picker.value = hex.value;
        }
      };
    }
  });
});

async function saveTheme() {
  const activeTheme = parseInt(document.querySelector('.theme-btn.active')?.dataset.theme || '0');
  const themeMode = parseInt(document.querySelector('.mode-btn.active')?.dataset.mode || '0');

  const data = {
    activeTheme,
    themeMode
  };

  // Include custom colors if custom theme is selected
  if (activeTheme === 2) {
    data.custom = {
      dark: {},
      light: {}
    };
    COLOR_FIELDS.forEach(field => {
      const darkHex = document.getElementById(`dark-${field}-hex`)?.value;
      const lightHex = document.getElementById(`light-${field}-hex`)?.value;
      if (darkHex && /^#[0-9A-Fa-f]{6}$/.test(darkHex)) {
        data.custom.dark[field] = hexToRgb565(darkHex);
      }
      if (lightHex && /^#[0-9A-Fa-f]{6}$/.test(lightHex)) {
        data.custom.light[field] = hexToRgb565(lightHex);
      }
    });
  }

  try {
    const r = await fetch('/api/themes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await r.json();
    showStatus('theme-status', result.success ? 'success' : 'error', result.message);
  } catch (e) {
    showStatus('theme-status', 'error', 'Failed to save theme');
  }
}

async function resetCustomTheme() {
  if (!confirm('Reset custom theme to Classic defaults?')) return;
  try {
    const r = await fetch('/api/themes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ resetCustom: true })
    });
    const result = await r.json();
    if (result.success) {
      // Reload theme data
      const themes = await fetch('/api/themes').then(r => r.json());
      updateThemes(themes);
      showStatus('theme-status', 'success', 'Custom theme reset');
    } else {
      showStatus('theme-status', 'error', result.message);
    }
  } catch (e) {
    showStatus('theme-status', 'error', 'Failed to reset theme');
  }
}

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
