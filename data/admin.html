<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EpicWeatherBox Admin</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,system-ui,sans-serif;background:#1a1a2e;color:#eee;min-height:100vh}
.container{max-width:800px;margin:0 auto;padding:15px}
h1{color:#00d4ff;text-align:center;padding:15px 0;font-size:1.5em}
.grid{display:grid;grid-template-columns:1fr;gap:15px}
@media(min-width:600px){.grid{grid-template-columns:260px 1fr}}
.card{background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;border:1px solid rgba(255,255,255,0.1)}
.card h3{color:#00d4ff;margin-bottom:12px;font-size:1em}
.preview-wrap{display:flex;flex-direction:column;align-items:center}
#preview{border:2px solid #333;border-radius:8px;background:#000;image-rendering:pixelated}
.preview-info{margin-top:8px;font-size:0.8em;color:#888}
.btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;transition:all 0.2s}
.btn-primary{background:#00d4ff;color:#1a1a2e}
.btn-primary:hover{background:#00a8cc}
.btn-secondary{background:rgba(255,255,255,0.1);color:#eee}
.btn-secondary:hover{background:rgba(255,255,255,0.2)}
.btn-add{background:rgba(0,212,255,0.15);color:#00d4ff;border:1px dashed #00d4ff}
.btn-add:hover{background:rgba(0,212,255,0.25)}
.form-group{margin-bottom:12px}
.form-group label{display:block;margin-bottom:4px;font-size:0.85em;color:#aaa}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px;border:1px solid #333;border-radius:6px;background:#2a2a4e;color:#eee;font-size:0.9em}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#00d4ff}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.weather-now{text-align:center;padding:10px}
.weather-temp{font-size:2.5em;font-weight:bold}
.weather-cond{font-size:1.1em;color:#aaa}
.weather-icon{font-size:2em}
.forecast{display:flex;justify-content:space-between;margin-top:10px;overflow-x:auto}
.forecast-day{text-align:center;padding:5px;min-width:45px}
.forecast-day .day{font-size:0.7em;color:#888}
.forecast-day .icon{font-size:1.2em}
.forecast-day .temp{font-size:0.8em}
.status{padding:8px;border-radius:6px;margin-top:10px;font-size:0.85em}
.status.success{background:rgba(0,200,100,0.2);color:#0c6}
.status.error{background:rgba(200,50,50,0.2);color:#f66}
.tabs{display:flex;border-bottom:1px solid #333;margin-bottom:15px}
.tab{padding:10px 15px;cursor:pointer;border-bottom:2px solid transparent;color:#888;font-size:0.9em}
.tab.active{color:#00d4ff;border-color:#00d4ff}
.tab-content{display:none}
.tab-content.active{display:block}
.links{margin-top:15px;text-align:center}
.links a{color:#00d4ff;margin:0 10px;font-size:0.85em}

/* Carousel styles */
.carousel-list{min-height:100px}
.carousel-item{background:rgba(255,255,255,0.03);border:1px solid #333;border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:grab}
.carousel-item:active{cursor:grabbing}
.carousel-item.dragging{opacity:0.5;border-color:#00d4ff}
.carousel-item .drag-handle{color:#666;font-size:1.2em}
.carousel-item .item-icon{font-size:1.3em}
.carousel-item .item-info{flex:1}
.carousel-item .item-title{font-weight:bold;font-size:0.9em}
.carousel-item .item-desc{font-size:0.75em;color:#888;margin-top:2px}
.carousel-item .item-remove{background:none;border:none;color:#666;font-size:1.2em;cursor:pointer;padding:4px 8px}
.carousel-item .item-remove:hover{color:#f66}
.carousel-counters{display:flex;gap:15px;margin-top:10px;font-size:0.8em;color:#888}
.add-buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

/* Modal styles */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#1a1a2e;border:1px solid #333;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal-content h3{color:#00d4ff;margin-bottom:15px}
.modal-buttons{display:flex;gap:10px;margin-top:15px;justify-content:flex-end}

/* Info boxes for system tab */
.info-box{background:rgba(255,255,255,0.05);border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.info-label{color:#888;font-size:0.85em}
.info-value{color:#00d4ff;font-weight:500}
</style>
</head>
<body>
<div class="container">
<h1>EpicWeatherBox</h1>
<div class="grid">
<div>
<div class="card preview-wrap">
<canvas id="preview" width="240" height="240"></canvas>
<div class="preview-info">240x240 Display Preview</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="cycleScreen()">Next Screen</button>
<button class="btn btn-secondary" onclick="refreshPreview()">Refresh</button>
</div>
</div>
<div class="card" style="margin-top:15px">
<h3>Current Weather</h3>
<div id="weather-display">Loading...</div>
</div>
</div>
<div>
<div class="card">
<div class="tabs">
<div class="tab active" data-tab="carousel">Carousel</div>
<div class="tab" data-tab="display">Display</div>
<div class="tab" data-tab="system">System</div>
</div>

<!-- CAROUSEL TAB -->
<div id="carousel" class="tab-content active">
<p style="font-size:0.85em;color:#888;margin-bottom:12px">Drag to reorder screens. Each location shows 3 screens (current + forecasts).</p>
<div id="carousel-list" class="carousel-list"></div>
<div class="add-buttons">
<button class="btn btn-add" onclick="openModal('location')">+ Location</button>
<button class="btn btn-add" onclick="openModal('countdown')">+ Countdown</button>
<button class="btn btn-add" onclick="openModal('custom')">+ Custom Text</button>
</div>
<div class="carousel-counters">
<span>Locations: <span id="loc-count">0</span>/3</span>
<span>Countdowns: <span id="cd-count">0</span>/3</span>
<span>Custom: <span id="cust-count">0</span>/3</span>
</div>
<div class="btn-row" style="margin-top:15px">
<button class="btn btn-primary" onclick="saveCarousel()">Save Carousel</button>
</div>
<div id="carousel-status"></div>
</div>

<!-- DISPLAY TAB -->
<div id="display" class="tab-content">
<div class="form-group">
<label>Temperature Unit</label>
<select id="temp-unit">
<option value="f">Fahrenheit</option>
<option value="c">Celsius</option>
</select>
</div>
<div class="form-group">
<label>Screen Cycle (seconds)</label>
<input type="number" id="cycle-time" value="10" min="3" max="60">
</div>
<div class="form-group">
<label>Brightness</label>
<input type="range" id="brightness" min="10" max="100" value="80">
<span id="brightness-val">80%</span>
</div>
<div class="btn-row">
<button class="btn btn-primary" onclick="saveDisplay()">Save Settings</button>
</div>
<div id="display-status"></div>
</div>

<!-- SYSTEM TAB -->
<div id="system" class="tab-content">
<div class="form-group">
<label>Device Info</label>
<div id="device-info">Loading...</div>
</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="refreshWeather()">Refresh Weather</button>
<button class="btn btn-secondary" onclick="location.href='/update'">Firmware Update</button>
<button class="btn btn-secondary" style="background:#c33" onclick="if(confirm('Reboot?'))location.href='/reboot'">Reboot</button>
</div>
</div>
</div>
</div>
</div>
<div class="links">
<a href="/">Home</a>
<a href="/api/weather">Weather API</a>
<a href="/api/status">Status API</a>
<a href="/safemode" style="color:#f90">Safe Mode</a>
</div>
</div>

<!-- MODALS -->
<div id="modal-location" class="modal">
<div class="modal-content">
<h3>Add Location</h3>
<div class="form-group">
<label>Location Name</label>
<input type="text" id="new-loc-name" placeholder="e.g., Seattle">
</div>
<div class="form-row">
<div class="form-group">
<label>Latitude</label>
<input type="number" id="new-loc-lat" step="0.0001" placeholder="47.6062">
</div>
<div class="form-group">
<label>Longitude</label>
<input type="number" id="new-loc-lon" step="0.0001" placeholder="-122.3321">
</div>
</div>
<button class="btn btn-secondary" onclick="useMyLocationForNew()" style="width:100%">Use My Location</button>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('location')">Cancel</button>
<button class="btn btn-primary" onclick="addLocation()">Add</button>
</div>
</div>
</div>

<div id="modal-countdown" class="modal">
<div class="modal-content">
<h3>Add Countdown</h3>
<div class="form-group">
<label>Event Type</label>
<select id="new-cd-type" onchange="updateCountdownFields()">
<option value="0">Birthday</option>
<option value="1">Easter</option>
<option value="2">Halloween</option>
<option value="3">Valentine's Day</option>
<option value="4">Christmas</option>
<option value="5">Custom Date</option>
</select>
</div>
<div class="form-group" id="cd-title-group">
<label>Title</label>
<input type="text" id="new-cd-title" maxlength="31" placeholder="e.g., Mom's Birthday">
</div>
<div class="form-row" id="cd-date-group">
<div class="form-group">
<label>Month</label>
<select id="new-cd-month">
<option value="1">January</option><option value="2">February</option><option value="3">March</option>
<option value="4">April</option><option value="5">May</option><option value="6">June</option>
<option value="7">July</option><option value="8">August</option><option value="9">September</option>
<option value="10">October</option><option value="11">November</option><option value="12">December</option>
</select>
</div>
<div class="form-group">
<label>Day</label>
<input type="number" id="new-cd-day" min="1" max="31" value="1">
</div>
</div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('countdown')">Cancel</button>
<button class="btn btn-primary" onclick="addCountdown()">Add</button>
</div>
</div>
</div>

<div id="modal-custom" class="modal">
<div class="modal-content">
<h3>Add Custom Text Screen</h3>
<div class="form-group">
<label>Header (max 16 chars)</label>
<input type="text" id="new-cust-header" maxlength="16" placeholder="e.g., Quote">
</div>
<div class="form-group">
<label>Body Text (max 80 chars)</label>
<textarea id="new-cust-body" maxlength="80" rows="3" placeholder="Your message..."></textarea>
<div style="font-size:0.75em;color:#666;margin-top:4px"><span id="new-body-count">0</span>/80</div>
</div>
<div class="form-group">
<label>Footer (max 30 chars)</label>
<input type="text" id="new-cust-footer" maxlength="30" placeholder="e.g., Have a great day!">
</div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeModal('custom')">Cancel</button>
<button class="btn btn-primary" onclick="addCustomScreen()">Add</button>
</div>
</div>
</div>

<script>
// Data storage
let carouselItems = [];
let locations = [];
let countdowns = [];
let customScreens = [];
let currentScreen = 0;

const canvas = document.getElementById('preview');
const ctx = canvas.getContext('2d');

const ICONS = {
  location: 'ðŸ“',
  countdown: {
    0: 'ðŸŽ‚', // Birthday
    1: 'ðŸ°', // Easter
    2: 'ðŸŽƒ', // Halloween
    3: 'â¤ï¸', // Valentine
    4: 'ðŸŽ„', // Christmas
    5: 'ðŸ“…'  // Custom
  },
  custom: 'ðŸ“'
};

const EVENT_NAMES = ['Birthday', 'Easter', 'Halloween', 'Valentine\'s', 'Christmas', 'Custom'];
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  };
});

// Brightness slider
document.getElementById('brightness').oninput = e => {
  document.getElementById('brightness-val').textContent = e.target.value + '%';
};

// Body character counter for new custom screen
document.getElementById('new-cust-body').oninput = e => {
  document.getElementById('new-body-count').textContent = e.target.value.length;
};

// Modal handling
function openModal(type) {
  document.getElementById('modal-' + type).classList.add('active');
  if (type === 'countdown') updateCountdownFields();
}

function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('active');
  // Clear fields
  if (type === 'location') {
    document.getElementById('new-loc-name').value = '';
    document.getElementById('new-loc-lat').value = '';
    document.getElementById('new-loc-lon').value = '';
  } else if (type === 'countdown') {
    document.getElementById('new-cd-type').value = '0';
    document.getElementById('new-cd-title').value = '';
    document.getElementById('new-cd-month').value = '1';
    document.getElementById('new-cd-day').value = '1';
  } else if (type === 'custom') {
    document.getElementById('new-cust-header').value = '';
    document.getElementById('new-cust-body').value = '';
    document.getElementById('new-cust-footer').value = '';
    document.getElementById('new-body-count').textContent = '0';
  }
}

function updateCountdownFields() {
  const type = parseInt(document.getElementById('new-cd-type').value);
  const titleGroup = document.getElementById('cd-title-group');
  const dateGroup = document.getElementById('cd-date-group');

  // Show/hide title based on type
  if (type === 0 || type === 5) { // Birthday or Custom
    titleGroup.style.display = 'block';
  } else {
    titleGroup.style.display = 'none';
  }

  // Show/hide date based on type (Easter is calculated)
  if (type === 1) { // Easter
    dateGroup.style.display = 'none';
  } else if (type === 2) { // Halloween - Oct 31
    dateGroup.style.display = 'none';
  } else if (type === 3) { // Valentine - Feb 14
    dateGroup.style.display = 'none';
  } else if (type === 4) { // Christmas - Dec 25
    dateGroup.style.display = 'none';
  } else {
    dateGroup.style.display = 'grid';
  }
}

// Render carousel list
function renderCarousel() {
  const list = document.getElementById('carousel-list');
  list.innerHTML = '';

  let locCount = 0, cdCount = 0, custCount = 0;

  carouselItems.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'carousel-item';
    div.draggable = true;
    div.dataset.index = idx;

    let icon, title, desc;
    if (item.type === 0) { // Location
      const loc = locations[item.dataIndex] || {};
      icon = ICONS.location;
      title = loc.name || 'Location ' + (item.dataIndex + 1);
      desc = `Lat: ${loc.lat?.toFixed(4) || '?'}, Lon: ${loc.lon?.toFixed(4) || '?'}`;
      locCount++;
    } else if (item.type === 1) { // Countdown
      const cd = countdowns[item.dataIndex] || {};
      icon = ICONS.countdown[cd.type] || 'ðŸ“…';
      title = cd.title || EVENT_NAMES[cd.type] || 'Countdown';
      if (cd.type === 1) {
        desc = 'Easter (calculated)';
      } else {
        desc = MONTH_NAMES[(cd.month || 1) - 1] + ' ' + (cd.day || 1);
      }
      cdCount++;
    } else { // Custom
      const cust = customScreens[item.dataIndex] || {};
      icon = ICONS.custom;
      title = cust.header || 'Custom Screen';
      desc = (cust.body || '').substring(0, 40) + (cust.body?.length > 40 ? '...' : '');
      custCount++;
    }

    div.innerHTML = `
      <span class="drag-handle">â˜°</span>
      <span class="item-icon">${icon}</span>
      <div class="item-info">
        <div class="item-title">${escapeHtml(title)}</div>
        <div class="item-desc">${escapeHtml(desc)}</div>
      </div>
      <button class="item-remove" onclick="removeCarouselItem(${idx})">Ã—</button>
    `;

    // Drag events
    div.ondragstart = e => {
      e.dataTransfer.setData('text/plain', idx);
      div.classList.add('dragging');
    };
    div.ondragend = () => div.classList.remove('dragging');
    div.ondragover = e => e.preventDefault();
    div.ondrop = e => {
      e.preventDefault();
      const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
      const toIdx = idx;
      if (fromIdx !== toIdx) {
        const item = carouselItems.splice(fromIdx, 1)[0];
        carouselItems.splice(toIdx, 0, item);
        renderCarousel();
      }
    };

    list.appendChild(div);
  });

  document.getElementById('loc-count').textContent = locCount;
  document.getElementById('cd-count').textContent = cdCount;
  document.getElementById('cust-count').textContent = custCount;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// Add items
function addLocation() {
  if (locations.length >= 3) {
    alert('Maximum 3 locations allowed');
    return;
  }
  const name = document.getElementById('new-loc-name').value.trim();
  const lat = parseFloat(document.getElementById('new-loc-lat').value);
  const lon = parseFloat(document.getElementById('new-loc-lon').value);

  if (!name || isNaN(lat) || isNaN(lon)) {
    alert('Please fill in all fields');
    return;
  }

  const idx = locations.length;
  locations.push({ name, lat, lon, enabled: true });
  carouselItems.push({ type: 0, dataIndex: idx });
  closeModal('location');
  renderCarousel();
}

function addCountdown() {
  if (countdowns.length >= 3) {
    alert('Maximum 3 countdowns allowed');
    return;
  }
  const type = parseInt(document.getElementById('new-cd-type').value);
  let title = document.getElementById('new-cd-title').value.trim();
  let month = parseInt(document.getElementById('new-cd-month').value);
  let day = parseInt(document.getElementById('new-cd-day').value);

  // Set defaults for preset types
  if (type === 1) { month = 4; day = 1; title = 'Easter'; } // Easter - date calculated
  else if (type === 2) { month = 10; day = 31; title = 'Halloween'; }
  else if (type === 3) { month = 2; day = 14; title = 'Valentine\'s Day'; }
  else if (type === 4) { month = 12; day = 25; title = 'Christmas'; }
  else if (!title) {
    alert('Please enter a title');
    return;
  }

  const idx = countdowns.length;
  countdowns.push({ type, month, day, title });
  carouselItems.push({ type: 1, dataIndex: idx });
  closeModal('countdown');
  renderCarousel();
}

function addCustomScreen() {
  if (customScreens.length >= 3) {
    alert('Maximum 3 custom screens allowed');
    return;
  }
  const header = document.getElementById('new-cust-header').value.trim();
  const body = document.getElementById('new-cust-body').value.trim();
  const footer = document.getElementById('new-cust-footer').value.trim();

  if (!body) {
    alert('Please enter body text');
    return;
  }

  const idx = customScreens.length;
  customScreens.push({ header, body, footer });
  carouselItems.push({ type: 2, dataIndex: idx });
  closeModal('custom');
  renderCarousel();
}

function removeCarouselItem(idx) {
  if (!confirm('Remove this item?')) return;

  const item = carouselItems[idx];
  carouselItems.splice(idx, 1);

  // Don't remove from data arrays - just from carousel
  // The dataIndex still points to the correct data

  renderCarousel();
}

function useMyLocationForNew() {
  if (!navigator.geolocation) {
    alert('Geolocation not supported');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    document.getElementById('new-loc-lat').value = pos.coords.latitude.toFixed(4);
    document.getElementById('new-loc-lon').value = pos.coords.longitude.toFixed(4);
  }, () => alert('Could not get location'));
}

// Save carousel
async function saveCarousel() {
  // Rebuild data arrays to only include items that are in the carousel
  // and fix dataIndex values to match their actual array positions
  const usedLocs = [];
  const usedCds = [];
  const usedCusts = [];
  const newCarousel = [];

  carouselItems.forEach(item => {
    if (item.type === 0) { // Location
      const loc = locations[item.dataIndex];
      if (loc) {
        const newIdx = usedLocs.length;
        usedLocs.push(loc);
        newCarousel.push({ type: 0, dataIndex: newIdx });
      }
    } else if (item.type === 1) { // Countdown
      const cd = countdowns[item.dataIndex];
      if (cd) {
        const newIdx = usedCds.length;
        usedCds.push(cd);
        newCarousel.push({ type: 1, dataIndex: newIdx });
      }
    } else if (item.type === 2) { // Custom
      const cust = customScreens[item.dataIndex];
      if (cust) {
        const newIdx = usedCusts.length;
        usedCusts.push(cust);
        newCarousel.push({ type: 2, dataIndex: newIdx });
      }
    }
  });

  const data = {
    carousel: newCarousel,
    locations: usedLocs,
    countdowns: usedCds,
    customScreens: usedCusts
  };

  try {
    const r = await fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await r.json();
    showStatus('carousel-status', result.success ? 'success' : 'error', result.message);
    if (result.success) setTimeout(() => location.reload(), 2000);
  } catch (e) {
    showStatus('carousel-status', 'error', 'Failed to save');
  }
}

// Load initial data
async function loadData() {
  try {
    const [weather, status, config] = await Promise.all([
      fetch('/api/weather').then(r => r.json()),
      fetch('/api/status').then(r => r.json()),
      fetch('/api/config').then(r => r.json()).catch(() => ({}))
    ]);
    updateWeatherDisplay(weather);
    updateDeviceInfo(status);
    updateConfig(config);
    drawPreview(weather);
  } catch (e) { console.error(e); }
}

function updateWeatherDisplay(data) {
  if (!data.primary || !data.primary.valid) {
    document.getElementById('weather-display').innerHTML = '<div class="status error">Weather unavailable</div>';
    return;
  }
  const w = data.primary;
  let html = `<div class="weather-now">
    <div class="weather-icon">${w.current.icon}</div>
    <div class="weather-temp">${Math.round(w.current.temperature)}Â°</div>
    <div class="weather-cond">${w.current.condition} - ${w.location}</div>
  </div><div class="forecast">`;
  w.forecast.slice(0, 5).forEach(d => {
    html += `<div class="forecast-day"><div class="day">${d.day}</div><div class="icon">${d.icon}</div><div class="temp">${Math.round(d.tempMax)}Â°</div></div>`;
  });
  html += '</div>';
  document.getElementById('weather-display').innerHTML = html;
}

function updateDeviceInfo(s) {
  document.getElementById('device-info').innerHTML = `
    <div class="info-box"><span class="info-label">Version</span><span class="info-value">${s.version}</span></div>
    <div class="info-box"><span class="info-label">IP Address</span><span class="info-value">${s.ip}</span></div>
    <div class="info-box"><span class="info-label">Uptime</span><span class="info-value">${Math.floor(s.uptime / 60)}m ${s.uptime % 60}s</span></div>
    <div class="info-box"><span class="info-label">Free RAM</span><span class="info-value">${(s.heap / 1024).toFixed(1)} KB</span></div>
    <div class="info-box"><span class="info-label">WiFi Signal</span><span class="info-value">${s.rssi} dBm</span></div>`;
}

function updateConfig(c) {
  // Load carousel items
  if (c.carousel && Array.isArray(c.carousel)) {
    carouselItems = c.carousel;
  } else {
    carouselItems = [];
  }

  // Load locations
  if (c.locations && Array.isArray(c.locations)) {
    locations = c.locations;
  } else {
    // Legacy format
    locations = [];
    if (c.primary) {
      locations.push({ name: c.primary.name, lat: c.primary.lat, lon: c.primary.lon, enabled: true });
    }
    if (c.secondary && c.secondary.enabled) {
      locations.push({ name: c.secondary.name, lat: c.secondary.lat, lon: c.secondary.lon, enabled: true });
    }
    // Create default carousel from locations
    if (carouselItems.length === 0) {
      locations.forEach((_, i) => carouselItems.push({ type: 0, dataIndex: i }));
    }
  }

  // Load countdowns
  if (c.countdowns && Array.isArray(c.countdowns)) {
    countdowns = c.countdowns;
  } else {
    countdowns = [];
  }

  // Load custom screens
  if (c.customScreens && Array.isArray(c.customScreens)) {
    customScreens = c.customScreens;
  } else if (c.customScreenEnabled && c.customScreenBody) {
    // Legacy single custom screen
    customScreens = [{
      header: c.customScreenHeader || '',
      body: c.customScreenBody || '',
      footer: c.customScreenFooter || ''
    }];
  } else {
    customScreens = [];
  }

  // Display settings
  if (c.display) {
    document.getElementById('temp-unit').value = c.display.unit || 'f';
    document.getElementById('cycle-time').value = c.display.cycle || 10;
    document.getElementById('brightness').value = c.display.brightness || 80;
    document.getElementById('brightness-val').textContent = (c.display.brightness || 80) + '%';
  }

  renderCarousel();
}

function drawPreview(data) {
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, 240, 240);
  if (!data || !data.primary || !data.primary.valid) {
    ctx.fillStyle = '#666';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('No weather data', 120, 120);
    return;
  }
  const w = data.primary;
  drawCurrentWeather(w);
}

function drawCurrentWeather(w) {
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, 240, 240);
  ctx.textAlign = 'center';
  ctx.fillStyle = '#00d4ff';
  ctx.font = 'bold 14px sans-serif';
  ctx.fillText(w.location, 120, 25);
  ctx.font = '60px sans-serif';
  ctx.fillText(w.current.icon, 120, 100);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 48px sans-serif';
  ctx.fillText(Math.round(w.current.temperature) + 'Â°', 120, 160);
  ctx.fillStyle = '#aaa';
  ctx.font = '16px sans-serif';
  ctx.fillText(w.current.condition, 120, 185);
  ctx.font = '12px sans-serif';
  ctx.fillText('Wind: ' + w.current.windSpeed + ' mph', 120, 210);
  const now = new Date();
  ctx.fillStyle = '#666';
  ctx.fillText(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 120, 232);
}

function cycleScreen() {
  // Just refresh preview for now
  fetch('/api/weather').then(r => r.json()).then(drawPreview);
}

function refreshPreview() {
  fetch('/api/weather').then(r => r.json()).then(drawPreview);
}

async function saveDisplay() {
  const data = {
    display: {
      unit: document.getElementById('temp-unit').value,
      cycle: parseInt(document.getElementById('cycle-time').value),
      brightness: parseInt(document.getElementById('brightness').value)
    }
  };
  try {
    const r = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    const result = await r.json();
    showStatus('display-status', result.success ? 'success' : 'error', result.message);
  } catch (e) { showStatus('display-status', 'error', 'Failed to save'); }
}

async function refreshWeather() {
  try {
    const r = await fetch('/api/weather/refresh');
    const result = await r.json();
    if (result.success) loadData();
  } catch (e) {}
}

function showStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.textContent = msg;
  setTimeout(() => el.textContent = '', 5000);
}

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
