<!Doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=0.8, minimal-ui">
		<meta name="author" content="GEEKMAGIC">
		<meta name="theme-color" content="#36393E" />
		<link rel="stylesheet" href="css/style.css">
		<script src="js/jquery.min.js"></script>
		<style>	
		input{background:#f1f1f1;border:0;padding:0 15px}
		#file-input,input{height:44px;border-radius:4px;margin:10px auto;font-size:15px}
		#file-input{width:60%;padding:0 10px;box-sizing:border-box;border:1px solid #ddd;line-height:44px;text-align:left;display:block;cursor:pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
		#bar,#prgbar{background-color:#f1f1f1;border-radius:10px}#bar{background-color:#00acc1;width:0;height:10px;}
		form{background:#2f3136;max-width:90%;margin:5px auto;padding:35px; padding-bottom: 30px;border-radius:12px;text-align:center; align-content: center;}
		</style>	
	</head>
	<body onload = "refreshPwd();getData('/city.json');getData('/w_i.json');getData('/unit.json');getData('/key.json');getData('/dst.json');getNav();">
		<nav id="nav" style="width: 80%;margin: 0 auto;font-size: 25px;text-align: center;">
		</nav>		
		<div class="container">
			<div class="row">
				<div class="col-12">
					<div id="popup" class="popup"></div>
					<h1>1. Set City Location</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-12">
				<h3>Set City Name,Country/Region Name, or City number</h3><p>
					Input your city location: <input type="text" name="city1" id="city1" placeholder="Seoul">
					<p>Location example, Seoul, the capital city of Korea, please input: Seoul</br>
					<a>[If there are several cities with the SAME name, you need to find the correct city number.]</a><p>
					<b>Tips：Where to find Your Own city number >>></b><p><a href="https://openweathermap.org/find" target="_blank">1.Click me to search your city number after internet is connected</a><p>
					<div id="ret" style="color:#FF0000"></div>2.Input your city name, click search and then choose the result, open it, the number at the link address tail is your city nuber! eg: Seoul,KR <b>https://openweathermap.org/city/<a>1835848</a></b>, <b><a>1835848</a></b> is city number of Seoul,KR.
				</div>
			</div>
			<div class="row">
				<div class="col-6">
					<button class="button-primary left" onclick="set_weather()">SAVE</button>
				</div>
			</div>	
			<div class="row">
				<div class="col-12">
					<h1>2. Unit format</h1>
				</div>
			</div>			
			<div class="row">				
				<div class="col-4">Wind Speed:<p>
					<select id="windspeed" style="width:200px">
					  <option value="m/s" style="display:none">m/s</option>
					  <option value="m/s">m/s</option>
					  <option value="km/h">km/h</option>
					  <option value="mile/h">mile/h</option>				  
					</select>	
				</div>
				<div class="col-4">
				Temperature:<p>
					<select id="temp" style="width:200px">
					  <option value="°C" style="display:none">°C</option>
					  <option value="°C">°C</option>
					  <option value="°F">°F</option>
					</select>
				</div>
				<div class="col-4">
				Atmospheric pressure:<p>
					<select id="pressure" style="width:200px">
					  <option value="hPa" style="display:none">hPa</option>
					  <option value="hPa">hPa</option>
					  <option value="kPa">kPa</option>
					  <option value="mmHg">mmHg</option>				  
					  <option value="inHg">inHg</option>				  
					</select>
				</div>				
			</div>	
			<div class="row">
				<div class="col-6">
					<button class="button-primary left" onclick="set_unit()">SAVE</button>
				</div>
			</div>			
			<div class="row">
				<div class="col-12">
					<h1>3. Weather Update Interval</h1>
				</div>
			</div>			
			<div class="row">
				<div class="col-12">
					By default, weather update interval is 20 minutes fixed, if you use your own api key, higher interval is allowed.<p>
					<input type="text" name="weather_interval" id="weather_interval" value="20">m(minutes)
				</div>
			</div>	
			<div class="row">
				<div class="col-6">
					<button class="button-primary left" onclick="set_weather_itv()">SAVE</button>
				</div>
			</div>	
			<div class="row">
				<div class="col-12">
					<h1>4. Weather API key [Recommended!]</h1>
				</div>
			</div>			
			<div class="row">
				<div class="col-12">
					Professional option, if you are not clear, please do not modify this.<p>
					But set your own api key can get higher weather update rate and will be more stable compared using the public key.<p>
					Register your key <a href="https://home.openweathermap.org/api_keys">here</a>, tips: NEW key would take 1-2 hours to take effect, be patient.<p>
					<input type="text" name="api" id="api" placeholder="xxxxxxxxxx">
				</div>
			</div>	
			<div class="row">
				<div class="col-6">
					<button class="button-primary left" onclick="set_key()">SAVE</button>
				</div>
			</div>		
			<div class="row">
				<div class="col-12">
					<h1>5. Weather Forecast API key [Recommended!]</h1>
				</div>
			</div>			
			<div class="row">
				<div class="col-12">
					We recommend setting up your own forecast key here as the public key may run out as a free service, follow the instructions <a href="https://h5.clewm.net/?url=qr61.cn%2FonQs0U%2Fqzj5qsW">here</a> to set it up.<p>
					<input type="text" name="api" id="forecastapi" placeholder="xxxxxxxxxx">
				</div>
			</div>	
			<div class="row">
				<div class="col-6">
					<button class="button-primary left" onclick="set_forecast_key()">SAVE</button>
				</div>
			</div>		
			<div class="row">
				<div class="col-12">
					<h1>6. Gif In The Weather Screen</h1>
				</div>
			</div>	
			<div class="row">
			<form method="POST" id="upload_form">
				<div class="model cut-img-model" style="display: none;">
				<div class="model-content" style="width: 350px;height: 400px;margin: 0px auto;">
				  <div class="cut-img-box">
					<img id="image" height="auto" width="100%">
				  </div>
				</div>
				</div>
				<span>Gif file size should be 80x80px, please <a target="_blank" href="http://ezgif.com">resize</a> before uploading!</span><br>
				<span>Gif example files <a target="_blank" href="https://github.com/GeekMagicClock/gif">here</a></span><br>
				<input type="file" name="update" id="selectImg" onchange="sub(this)" accept="image/gif" style="display:none">
				<label id="file-input" for="selectImg">   Choose...</label>
				<input type="submit" id="updateBtn" class="btn2" disabled="true" value="UPLOAD">
				<input type="button" id="btnback" class="btn" onclick="refreshPwd()" path="/gif" value="RELOAD">
				<input type="button" id="btnclear" class="btn" onclick="clearDir()" value="CLEAR">
				<br>
				<div id="prg" style="display:none">Ready to upload</div>
				<br><div id="prgbar" style="width:60%;margin:0 auto;display:none"><div id="bar"></div></div>
				<h4><span id="free"></span>, Current Path:<span id="pwd">/gif</span></h4>
				<span id="filelist"><table id="list"></table></span>
				<br>
			</form>	
			</div>	
			<div class="row">
				<div class="col-12">
					<br />
					<div id="copyright">
					</div>						
					<script src="js/settings.js"></script>
				</div>
			</div>
		</div>
		<script>
			function set_key(){
				var x=getE("api");
				var url = "/set?key="+x.value.replace(/ /g,"");
				send_http(url);
			}			
			function set_forecast_key(){
				var x=getE("forecastapi");
				var url = "/set?fkey="+x.value.replace(/ /g,"");
				send_http(url);
			}	
			function set_unit(){
				var x=getE("windspeed");
				var y=getE("temp");
				var z=getE("pressure");
				var url = "/set?w_u="+x.value.replace(/ /g,"")+"&t_u="+y.value.replace(/ /g,"")+"&p_u="+z.value.replace(/ /g,"");
				send_http(url);
			}			
			function set_weather(){
				var x=getE("city1");
				if(x.value == ""){
					alert("city location or city number can't be both empty.");
					var ret = getE("ret");
					ret.innerHTML="Please input city location or city number."
				}else{
					var xt = x.value.trim();
					if(!isNaN(xt.charAt(0)))//数字
						url = "/set?cd1="+xt.replace(/ /g,"")+"&cd2=1000";
					else{//字符
						url = "/set?cd1="+xt+"&cd2=1000";
					}
					getResponse(url, function(responseText) {
						var err = getE("error");
						if (responseText == "OK") {
							showPopup("Saved Successfully!", 1000, "#02a601");
						}else{
							showPopup("Save faild!",1000, "#dc0d04");
						} 
					});
				}	
			}
			function set_weather_itv(){
				var interval = getE('weather_interval').value;
				url = "/set?w_i="+interval.replace(/ /g,"");
				send_http(url);
			}
			function refreshPwd(){
				var path = $('#pwd').html();
				if(path == "") path = "/gif";
				var xhr = new XMLHttpRequest();
				var fnstring = String("/filelist?dir=")+path;
				xhr.open("GET", fnstring, true);
				xhr.send();
				xhr.onreadystatechange = function() {
					if (xhr.readyState == XMLHttpRequest.DONE) {
						if(xhr.responseText != "Empty" && xhr.responseText != "Fail")
							$("#list").replaceWith(xhr.responseText);
							//$("#list").replaceWith("<table id=\"list\"></table>");
					}
				}
				var xh = new XMLHttpRequest();
				var fnstring = String("/space.json");
				xh.open("GET", fnstring, true);
				xh.send();
				xh.onreadystatechange = function() {
					if (xh.readyState == XMLHttpRequest.DONE) {
						var rsp = JSON.parse(xh.responseText)
						if(rsp.free != ""){							
							getE("free").innerText = "Free Space:"+Math.floor(rsp.free/1024) +"KB";
						}						
					}
				}				
			}
			function clearDir() {
				var ret = confirm("Confirm? Do you want to delete all the images?");
				if(!ret) return;
				var xhr = new XMLHttpRequest();
				var fnstring=String("/set?clear=gif");
				xhr.open("GET", fnstring, true);
				xhr.send();
				xhr.onreadystatechange = function() {
					if (xhr.readyState == XMLHttpRequest.DONE) {
						alert("Clear Done");
						refreshPwd();
					}
				}
			}
			function deletef(h) {
				var xhr = new XMLHttpRequest();
				var url=String("/delete?file=")+encodeURIComponent(h);
				xhr.open("GET", url, true);
				xhr.send();
				xhr.onreadystatechange = function() {
					if (xhr.readyState == XMLHttpRequest.DONE) {
						alert("Delete done");
						refreshPwd();
					}
				}
			}
			function setgif(f){
				var url = String("/set?gif=")+encodeURIComponent(f);
				send_http(url);
			}
			function sub(obj){
			  var a = obj.value;
			  var fileName = a.replace(/^.*[\\\/]/, '');
			  fileName = fileName.replace(/&/g, '_');
			  var len = fileName.length;
			  if(fileName.length>30){
				fileName = fileName.substring(len-20);
			  }
			  getE('file-input').innerHTML = fileName;
			  getE('updateBtn').disabled = false;
			  getE('prgbar').style.display = 'block';
			  getE('prg').style.display = 'block';
			};
			function ready_to_upload(){
				getE('prgbar').style.display = 'none';
				getE('prg').style.display = 'none';
				$('#prg').html('Ready to upload');
				$('#bar').css('width:0px');
				getE('file-input').innerHTML = 'Choose file...';
				getE('updateBtn').disabled = true;
				setTimeout(refreshPwd, 1000);
			}
			$('#upload_form').submit(function(e){
				getE('updateBtn').disabled = true;  
				e.preventDefault();
				var form = $('#upload_form')[0];
				var data = new FormData(form);
				var fileInput = getE('selectImg');
				var file;
				if (fileInput.files.length = 0) return;
				else {
					file = fileInput.files[0];
					var formData = new FormData();
					formData.append('image', file);
				}
				
				var fileName = getE('file-input').innerHTML;
				if(fileName.length>30){
					fileName = fileName.substring(len-20);
				}
				data.append("image", file, fileName);				
				var dir = $("#pwd").html();
				var format = fileName.toLowerCase().substring(fileName.lastIndexOf('.') + 1);
				if(format == "gif") {
					$.ajax({
						url: '/doUpload?dir='+dir,
						type: 'POST',
						data: data,
						contentType: false,
						processData:false,
						xhr: function() {
							var xhr = new window.XMLHttpRequest();
							xhr.upload.addEventListener('progress', function(evt) {
								if (evt.lengthComputable) {
									var per = evt.loaded / evt.total;
									$('#prg').html('Uploading, please wait... ');
									$('#bar').css('width', Math.round(per*350)+"px");
									}
							}, false);
							return xhr;
						},
						success:function(d, s) {
							ready_to_upload();

						},
						error: function (a, b, c) {
							ready_to_upload();

						}
					});
				}else{
					getE('updateBtn').disabled = false;  
					alert("Please upload gif format file!");
				}
			});

		</script>		
	</body>
</html>