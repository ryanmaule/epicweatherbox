<!Doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=0.8, minimal-ui">
		<meta name="author" content="GEEKMAGIC">
		<meta name="theme-color" content="#36393E" />
		<style>		
		input{background:#2f3136;border:0;padding:0 15px}
		#file-input,input{height:44px;border-radius:4px;margin:10px auto;font-size:15px}
		#file-input{width:60%;padding:0 10px;box-sizing:border-box;border:1px solid #ddd;line-height:44px;text-align:left;display:block;cursor:pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
		#bar,#prgbar{background-color:#f1f1f1;border-radius:10px}#bar{background-color:#00acc1;width:0;height:10px;}
		form{background:#2f3136;max-width:100%;margin:5px auto;padding:35px; padding-bottom: 30px;border-radius:12px;text-align:center; align-content: center;}
		.btn {background-color: #35383a;box-shadow: 0 0 8px 0 rgba(0, 0, 0, 0.08), 0 0 15px 0 rgba(0, 0, 0, 0.02), 0 0 20px 4px rgba(0, 0, 0, 0.06);color: white;border-radius: 4px;padding: 9px 16px;background-image: none;}
	</style>
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/cropper.min.css">
		<script src="js/cropper.min.js"></script>
		<script src="js/jquery.min.js"></script>  				
	</head>
	<body onload = "refreshPwd();getData('/album.json');getNav();">
		<nav id="nav" style="width: 80%;margin: 0 auto;font-size: 25px;text-align: center;">
		</nav>
		<div class="container">
			<div class="row">
				<div class="col-12">
					<div id="popup" class="popup"></div>
					<h1>1. Auto display</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-6">
					<label for="autoplay">Enable image auto display:</label>
				</div>
				<div class="col-6">
					<input type="checkbox" id="autoplay" name="autoplay" />
				</div>
				<div class="col-6">
					<label for="hour12">JPG image display interval:</label>
				</div>
				<div class="col-6">
					<input type="text" name="image_interval" id="image_interval" value="30">s(seconds)
				</div>
			</div>				
			<div class="row">

				<div class="col-12">
					<button class="button-primary left" onclick="set_image()">SAVE</button>
				</div>
			</div>		
			<div class="row">
				<div class="col-12">
					<div id="error" class="hide"></div>
					<h1>2. Picture management</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-12">
					<div id="error" class="hide"></div>
					<form method="POST" id="upload_form">
					  <div class="model cut-img-model" style="display: none;">
						<div class="model-content" style="width: 350px;height: 400px;margin: 0px auto;">
						  <div class="cut-img-box">
							<img id="image" height="auto" width="100%">
						  </div>
						  <p class="instructions">Please crop and resize to 240x240px</p>
						  <div class=" btn-container" style="width: 240px;margin: 0px auto;">
							<div id="cancel" style="width: 40px;float:left;" class = "btn">CANCEL</div>
							<div id="rotate" style="width: 40px;float:left;margin-left:10px;" class = "btn">ROTATE</div>
							<div id="crop" style="width: 40px;float:left;margin-left:10px;" class = "btn">SAVE</div>
						  </div>
						</div>
					  </div>
					<div class="row" id="tip" style="float:center;">
					  	<span>1. Support JPG/GIF format file only.</span><br>
					  	<span>2. GIF files should be <a target="_blank" href="http://ezgif.com">resized</a> to 240x240px before uploadÔºÅ</span><br>
					  	<span>3. Example gif files could be downloaded <a target="_blank" href="https://github.com/GeekMagicClock/gif">here</a>.</span><br>						
					</div>
					<input type="file" name="update" id="selectImg" onchange="sub(this)" accept="image/jpeg, image/gif" style="display:none">
					<label id="file-input" for="selectImg">   Choose...</label>
					<input type="submit" id="updateBtn" class="btn2" disabled="true" value="UPLOAD">
					<input type="button" id="btnback" class="btn" onclick="refreshPwd()" path="/image" value="RELOAD">
					<input type="button" id="btnclear" class="btn" onclick="clearDir()" value="CLEAR">
					<br>
					<div id="prg" style="display:none">Ready to upload</div>
					<br><div id="prgbar" style="width:60%;margin:0 auto;display:none"><div id="bar"></div></div>
					<h4><span id="free"></span>, Current path:<span id="pwd">/image/</span></h4>
						<span id="filelist"><table id="list"></table></span>
					<br>
					</form>	
				</div>
				<script src="js/settings.js"></script>
			</div>					
			<script>
				var image1 = $('#image');
				var cropper = new Cropper(image, {
					aspectRatio:1/1,
					viewMode: 1,
					ContainerWidth: 240,
					ContainerHeight: 240,
					dragMode: 'move',
					autoCropArea: 1, 
					restore: false,
					modal: false,
					guides: true,
					highlight: false,
					cropBoxMovable: true,
					cropBoxResizable: true,
					toggleDragModeOnDblclick: false,
				});
				$("#image").on('ready.cropper', function () {
					var h = $(".cut-img-box").height() - 280;
					$("#tip").css("margin-top",h); 
				});
				$('#selectImg').on('change',function(e){
				  var file = e.target.files[0];
				  var format = file.name.toLowerCase().substring(file.name.lastIndexOf('.') + 1);
				  if(format != "jpg" && format != "jpeg") return;
				  $(".cut-img-model").show(); 
				  var reader = new FileReader();  
				  reader.onload = function(evt) {  
					  var replaceSrc = evt.target.result;
					  cropper.replace(replaceSrc, false);
				  }
				  reader.readAsDataURL(file);
				})
				$('#rotate').on('click', function() {
				  cropper.rotate(90);
				})	
				$('#crop').on('click', function() {
				  $(".cut-img-model").toggle(); 
				  $("#tip").css("margin-top",0); 
				  var src = cropper.getCroppedCanvas({width:240,height:240}).toDataURL('image/jpeg', 0.9);
				})
				$('#cancel').on('click', function() {
					$(".cut-img-model").toggle();
				})	
				function refreshPwd(){
					var path = $('#pwd').html();
					if(path == "") path = "/";
					var xhr = new XMLHttpRequest();
					var fnstring = String("/filelist?dir=")+path;
					xhr.open("GET", fnstring, true);
					xhr.send();
					xhr.onreadystatechange = function() {
						if (xhr.readyState == XMLHttpRequest.DONE) {
							if(xhr.responseText != "")
							$("#list").replaceWith(xhr.responseText);
						}
					}
					var xh = new XMLHttpRequest();
					var fnstring = String("/space.json");
					xh.open("GET", fnstring, true);
					xh.send();
					xh.onreadystatechange = function() {
						if (xh.readyState == XMLHttpRequest.DONE) {
							var rsp = JSON.parse(xh.responseText)
							if(rsp.free != ""){							
								getE("free").innerText = "Free Space:"+ Math.floor(rsp.free/1024) +"KB";
							}						
						}
					}	
				}
				function clearDir() {
					var ret = confirm("Confirm? Do you want to delete all the images?");
				    if(!ret) return;
				    var xhr = new XMLHttpRequest();
				    var fnstring=String("/set?clear=image");
				    xhr.open("GET", fnstring, true);
					xhr.send();
					xhr.onreadystatechange = function() {
						if (xhr.readyState == XMLHttpRequest.DONE) {
							alert("Clear done");
							refreshPwd();
						}
					}
				}				
				function deletef(h) {
				   var xhr = new XMLHttpRequest();
				   var fnstring=String("/delete?file=")+encodeURIComponent(h);
				   xhr.open("GET", fnstring, true);
					xhr.send();
					xhr.onreadystatechange = function() {
						if (xhr.readyState == XMLHttpRequest.DONE) {
							alert("Delete done");
							refreshPwd();
						}
					}
				}
				function setgif(f){
					var url = String("/set?img=")+encodeURIComponent(f);
					send_http(url);
				}				
				function sub(obj){
				  var a = obj.value;
				  var fileName = a.replace(/^.*[\\\/]/, '');
				  fileName = fileName.replace(/&/g, '_');
				  var len = fileName.length;
				  if(fileName.length>30){
					fileName = fileName.substring(len-20);
				  }
				  getE('file-input').innerHTML = fileName;
				  getE('selectImg').innerHTML = fileName;
				  getE('updateBtn').disabled = false;
				  getE('prgbar').style.display = 'block';
				  getE('prg').style.display = 'block';
				};
				function ready_to_upload(){
					getE('prgbar').style.display = 'none';
					getE('prg').style.display = 'none';
					$('#prg').html('Ready to upload');
					$('#bar').css('width:0px');
					getE('file-input').innerHTML = 'Choose file...';
					getE('updateBtn').disabled = true;
					setTimeout(refreshPwd, 1000);
				}
				$('#upload_form').submit(function(e){
					getE('updateBtn').disabled = "disabled";  
					e.preventDefault();
					var form = $('#upload_form')[0];
					var data = new FormData(form);
					var fileInput = document.getElementById('selectImg');
					var file;
					if (fileInput.files.length = 0) return;
					else {
						file = fileInput.files[0];
						var formData = new FormData();
						formData.append('image', file);
					}
					
					var fileName = getE('file-input').innerHTML;
					if(fileName.length>30){
						fileName = fileName.substring(len-20);
					}
					data.append("image", file, fileName);
					var dir = $("#pwd").html();
					var format = fileName.toLowerCase().substring(fileName.lastIndexOf('.') + 1);
					if(format != "jpg" && format != "jpeg") {
						$.ajax({
							url: '/doUpload?dir='+dir,
							type: 'POST',
							data: data,
							contentType: false,
							processData:false,
							xhr: function() {
								var xhr = new window.XMLHttpRequest();
								xhr.upload.addEventListener('progress', function(evt) {
									if (evt.lengthComputable) {
										var per = evt.loaded / evt.total;
										$('#prg').html('Progress: ' + Math.round(per*100));
										$('#bar').css('width', Math.round(per*350)+"px");
										}
								}, false);
								return xhr;
							},
							success:function(d, s) {
								ready_to_upload();
							},
							error: function (a, b, c) {
								ready_to_upload();

							}
						});
					}else{
						var canvas = cropper.getCroppedCanvas({width:240,height:240});
						var src = cropper.getCroppedCanvas({width:240,height:240}).toDataURL('image/jpeg', 0.9);
						canvas.toBlob(function (blob){
							var formData = new FormData();
							formData.append('file', blob, getE('file-input').innerHTML);
							$.ajax({
								url: '/doUpload?dir='+dir,
								type: 'POST',
								data: formData,
								contentType: false,
								processData:false,
								xhr: function() {
									var xhr = new window.XMLHttpRequest();
									xhr.upload.addEventListener('progress', function(evt) {
										if (evt.lengthComputable) {
											var per = evt.loaded / evt.total;
											$('#prg').html('Progress: ' + Math.round(per*100));
											$('#bar').css('width', Math.round(per*350)+"px");
											}
									}, false);
									return xhr;
								},
								success:function(d, s) {
									ready_to_upload();
								},
								error: function (a, b, c) {
									ready_to_upload();
								}
							});
						
					
							console.log("upload "+dir);
						},"image/jpeg", 0.9);
					}
				});
				function set_image(){
					var autoplay = getE("autoplay");
					if(autoplay.checked) autoplay.value=1;
					else autoplay.value=0;
					var image_interval = getE("image_interval");
					var url = "/set?i_i="+image_interval.value+"&autoplay="+autoplay.value;
					send_http(url);	
				}
				</script>					
		</div>
			<div class="row">
				<div class="col-12">
					<br />
					<div id="copyright">
					</div>						
					<script src="js/settings.js"></script>
				</div>
			</div>
	</body>
</html>